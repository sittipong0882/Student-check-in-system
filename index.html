<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üéì</div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
                <p class="text-gray-600">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="showAdminLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    üë®‚Äçüè´ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π/‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
                </button>
                <button onclick="showStudentLogin()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    üë©‚Äçüéì ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="adminLoginScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üë®‚Äçüè´</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π</h2>
            </div>
            
            <form onsubmit="adminLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                    <input type="text" id="adminUsername" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" required>
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="adminPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏£‡∏´‡∏±‡∏™" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
                <button type="button" onclick="backToLogin()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                </button>
            </form>
        </div>
    </div>

    <!-- Student Login -->
    <div id="studentLoginScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üë©‚Äçüéì</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
            </div>
            
            <form onsubmit="studentLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <input type="text" id="studentId" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" required>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
                <button type="button" onclick="backToLogin()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üë®‚Äçüè´</span>
                        <h1 class="text-2xl font-bold text-gray-900">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏π</h1>
                    </div>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200">
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-blue-600 text-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button onclick="showSubjectManagement()" class="py-4 px-2 border-b-2 border-transparent hover:border-white transition duration-200">
                        üìö ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤
                    </button>
                    <button onclick="showStudentManagement()" class="py-4 px-2 border-b-2 border-transparent hover:border-white transition duration-200">
                        üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    </button>
                    <button onclick="showAttendanceManagement()" class="py-4 px-2 border-b-2 border-transparent hover:border-white transition duration-200">
                        ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
                    </button>
                    <button onclick="showReports()" class="py-4 px-2 border-b-2 border-transparent hover:border-white transition duration-200">
                        üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•
                    </button>
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Subject Management -->
            <div id="subjectManagement" class="hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">üìö ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h2>
                        <button onclick="showAddSubjectForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤
                        </button>
                    </div>
                    
                    <!-- Add Subject Form -->
                    <div id="addSubjectForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                        <form onsubmit="addSubject(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤</label>
                                <input type="text" id="subjectCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</label>
                                <input type="text" id="subjectName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div class="md:col-span-2">
                                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg mr-2 transition duration-200">
                                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                </button>
                                <button type="button" onclick="hideAddSubjectForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Subjects List -->
                    <div id="subjectsList" class="overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="subjectsTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Student Management -->
            <div id="studentManagement" class="hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                        <button onclick="showAddStudentForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        </button>
                    </div>
                    
                    <!-- Add Student Form -->
                    <div id="addStudentForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                        <form onsubmit="addStudent(event)" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                <input type="text" id="studentCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                <input type="text" id="studentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                                <input type="text" id="studentGrade" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div class="md:col-span-3">
                                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg mr-2 transition duration-200">
                                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                </button>
                                <button type="button" onclick="hideAddStudentForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Students List -->
                    <div id="studentsList" class="overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Attendance Management -->
            <div id="attendanceManagement" class="hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                    
                    <!-- Selection Controls -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                            <select id="gradeSelect" onchange="loadStudentsByGrade()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</label>
                            <select id="subjectSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="date" id="attendanceDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <!-- Attendance List -->
                    <div id="attendanceList" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                            <div class="space-x-2">
                                <button onclick="saveAttendance()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200">
                                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
                                </button>
                                <button onclick="showAttendanceHistory()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                                    ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ
                                </button>
                            </div>
                        </div>
                        <div id="studentsAttendanceList" class="space-y-3">
                        </div>
                        <div id="attendanceReport" class="hidden mt-6 p-4 bg-blue-50 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h4>
                            <div id="attendanceReportContent" class="text-blue-700">
                            </div>
                        </div>

                        <!-- Attendance Records Table -->
                        <div id="attendanceRecordsTable" class="hidden mt-6">
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-bold text-gray-800">üìã ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                                    <div class="space-x-2">
                                        <button onclick="refreshAttendanceTable()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm transition duration-200">
                                            üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                                        </button>
                                        <button onclick="deleteAllAttendanceForDate()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm transition duration-200">
                                            üóëÔ∏è ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Filter Controls -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π</label>
                                        <input type="date" id="tableDateFilter" onchange="loadAttendanceRecordsTable()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <div class="text-xs text-gray-500 mt-1">‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π</label>
                                        <select id="tableSubjectFilter" onchange="loadAttendanceRecordsTable()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                            <option value="">-- ‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°</label>
                                        <select id="tableSortOrder" onchange="loadAttendanceRecordsTable()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                            <option value="asc">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ô‡πâ‡∏≠‡∏¢ ‚Üí ‡∏°‡∏≤‡∏Å)</option>
                                            <option value="desc">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏°‡∏≤‡∏Å ‚Üí ‡∏ô‡πâ‡∏≠‡∏¢)</option>
                                            <option value="name_asc">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏Å ‚Üí ‡∏Æ)</option>
                                            <option value="name_desc">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏Æ ‚Üí ‡∏Å)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                        <select id="tableStatusFilter" onchange="loadAttendanceRecordsTable()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                            <option value="">-- ‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
                                            <option value="present">‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                                            <option value="absent">‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                                            <option value="late">‚è∞ ‡∏™‡∏≤‡∏¢</option>
                                            <option value="business">üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
                                            <option value="sick">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Quick Filter Buttons -->
                                <div class="flex flex-wrap gap-2 mb-4">
                                    <button onclick="setTableDateToToday()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                                        üìÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                                    </button>
                                    <button onclick="setTableDateToYesterday()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                                        üìÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô
                                    </button>
                                    <button onclick="clearTableFilters()" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                                        üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full table-auto">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('studentCode')">
                                                    ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <span id="sort-studentCode">‚ÜïÔ∏è</span>
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('studentName')">
                                                    ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <span id="sort-studentName">‚ÜïÔ∏è</span>
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                            </tr>
                                        </thead>
                                        <tbody id="attendanceRecordsTableBody" class="bg-white divide-y divide-gray-200">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance History Modal -->
                    <div id="attendanceHistoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h3>
                                <button onclick="closeAttendanceHistory()" class="text-gray-500 hover:text-gray-700">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div id="attendanceHistoryContent">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Report Detail -->
            <div id="studentReportDetail" class="hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                            <p id="studentReportInfo" class="text-gray-600 mt-1"></p>
                        </div>
                        <button onclick="backToStudentManagement()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö
                        </button>
                    </div>
                    
                    <div id="studentReportContent" class="space-y-6">
                    </div>
                </div>
            </div>

            <!-- Reports -->
            <div id="reports" class="hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                        <button onclick="exportReport()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            üìÑ Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                            <select id="reportGradeSelect" onchange="loadReportData()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</label>
                            <select id="reportSubjectSelect" onchange="loadReportData()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
                            </select>
                        </div>
                    </div>

                    <div id="reportData" class="overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏≤‡∏¢</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Student Dashboard -->
    <div id="studentDashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üë©‚Äçüéì</span>
                        <h1 class="text-2xl font-bold text-gray-900">‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
                        <span id="studentInfo" class="ml-4 text-gray-600"></span>
                    </div>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200">
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>
        </header>

        <!-- Student Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Student Info Card -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
                    <div id="studentDetails" class="space-y-3">
                    </div>
                </div>

                <!-- Attendance Summary -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</label>
                        <select id="studentSubjectSelect" onchange="loadStudentSubjectSummary()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            <option value="">-- ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
                        </select>
                    </div>
                    <div id="attendanceSummary" class="space-y-4">
                    </div>
                </div>
            </div>

            <!-- Subject Reports -->
            <div class="mt-8 space-y-6" id="subjectReports">
            </div>
        </main>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBcgffOPz842O-EAD2Hj8RyOpt08MJyzwc",
            authDomain: "student-check-in-system-86d39.firebaseapp.com",
            projectId: "student-check-in-system-86d39",
            storageBucket: "student-check-in-system-86d39.firebasestorage.app",
            messagingSenderId: "775189689512",
            appId: "1:775189689512:web:fb49659c49d33fde93be9d",
            measurementId: "G-PVC8XHXEFC"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let currentUserType = null;
        let subjects = [];
        let students = [];
        let attendanceRecords = [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            loadInitialData();
        });

        // Login Functions
        function showAdminLogin() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminLoginScreen').classList.remove('hidden');
        }

        function showStudentLogin() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('studentLoginScreen').classList.remove('hidden');
        }

        function backToLogin() {
            document.getElementById('adminLoginScreen').classList.add('hidden');
            document.getElementById('studentLoginScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function adminLogin(event) {
            event.preventDefault();
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;

            if (!username || !password) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            if (username === 'Admin' && password === '1234') {
                currentUser = 'admin';
                currentUserType = 'admin';
                Swal.fire({
                    icon: 'success',
                    title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    showAdminDashboard();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                    confirmButtonText: '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        async function studentLogin(event) {
            event.preventDefault();
            const studentId = document.getElementById('studentId').value;

            if (!studentId) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            // Show loading
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const studentDoc = await db.collection('students').doc(studentId).get();
                if (studentDoc.exists) {
                    currentUser = studentId;
                    currentUserType = 'student';
                    Swal.fire({
                        icon: 'success',
                        title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${studentDoc.data().name}`,
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        showStudentDashboard(studentDoc.data());
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                        text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                        confirmButtonText: '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
                        confirmButtonColor: '#ef4444'
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        function logout() {
            currentUser = null;
            currentUserType = null;
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('studentDashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Reset forms
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('studentId').value = '';
        }

        // Dashboard Functions
        function showAdminDashboard() {
            document.getElementById('adminLoginScreen').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            showSubjectManagement();
            loadSubjects();
            loadStudents();
        }

        async function showStudentDashboard(studentData) {
            document.getElementById('studentLoginScreen').classList.add('hidden');
            document.getElementById('studentDashboard').classList.remove('hidden');
            
            // Display student info
            document.getElementById('studentInfo').textContent = `${studentData.name} (${studentData.grade})`;
            
            // Load student details
            await loadStudentDetails(studentData);
        }

        // Navigation Functions
        function showSubjectManagement() {
            hideAllSections();
            document.getElementById('subjectManagement').classList.remove('hidden');
            loadSubjects();
        }

        function showStudentManagement() {
            hideAllSections();
            document.getElementById('studentManagement').classList.remove('hidden');
            loadStudents();
        }

        function showAttendanceManagement() {
            hideAllSections();
            document.getElementById('attendanceManagement').classList.remove('hidden');
            loadGrades();
            loadSubjectsForAttendance();
        }

        function showReports() {
            hideAllSections();
            document.getElementById('reports').classList.remove('hidden');
            loadGradesForReport();
            loadSubjectsForReport();
        }

        function hideAllSections() {
            document.getElementById('subjectManagement').classList.add('hidden');
            document.getElementById('studentManagement').classList.add('hidden');
            document.getElementById('attendanceManagement').classList.add('hidden');
            document.getElementById('reports').classList.add('hidden');
            document.getElementById('studentReportDetail').classList.add('hidden');
        }

        // Student Report Functions
        async function viewStudentReport(studentCode, studentName, studentGrade) {
            hideAllSections();
            document.getElementById('studentReportDetail').classList.remove('hidden');
            document.getElementById('studentReportInfo').textContent = `${studentCode} - ${studentName} (${studentGrade})`;
            
            try {
                // Get all subjects
                const subjectsSnapshot = await db.collection('subjects').get();
                const subjectsMap = {};
                subjectsSnapshot.forEach(doc => {
                    const subject = doc.data();
                    subjectsMap[subject.code] = subject.name;
                });

                // Get attendance records for this student
                const attendanceSnapshot = await db.collection('attendance')
                    .where('studentCode', '==', studentCode)
                    .get();

                const attendanceBySubject = {};
                attendanceSnapshot.forEach(doc => {
                    const record = doc.data();
                    if (!attendanceBySubject[record.subject]) {
                        attendanceBySubject[record.subject] = {
                            present: 0, absent: 0, late: 0, business: 0, sick: 0
                        };
                    }
                    attendanceBySubject[record.subject][record.status]++;
                });

                // Display report
                const contentDiv = document.getElementById('studentReportContent');
                contentDiv.innerHTML = '';

                // Overall summary
                let totalPresent = 0, totalAbsent = 0, totalLate = 0, totalBusiness = 0, totalSick = 0;
                Object.values(attendanceBySubject).forEach(attendance => {
                    totalPresent += attendance.present;
                    totalAbsent += attendance.absent;
                    totalLate += attendance.late;
                    totalBusiness += attendance.business;
                    totalSick += attendance.sick;
                });

                const totalDays = totalPresent + totalAbsent + totalLate + totalBusiness + totalSick;
                const effectiveAbsent = totalAbsent + Math.floor((totalLate + totalBusiness + totalSick) / 2);
                const overallPercentage = totalDays > 0 ? ((totalDays - effectiveAbsent) / totalDays * 100).toFixed(1) : 0;
                const overallStatus = effectiveAbsent >= 4 ? '‡∏Ç‡∏£ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏™‡∏≠‡∏ö)' : '‡∏õ‡∏Å‡∏ï‡∏¥';

                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'bg-gray-50 p-6 rounded-lg mb-6';
                summaryDiv.innerHTML = `
                    <h3 class="text-lg font-bold mb-4">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${totalPresent}</div>
                            <div class="text-sm text-gray-600">‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600">${totalAbsent}</div>
                            <div class="text-sm text-gray-600">‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-600">${totalLate}</div>
                            <div class="text-sm text-gray-600">‚è∞ ‡∏™‡∏≤‡∏¢</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${totalBusiness}</div>
                            <div class="text-sm text-gray-600">üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600">${totalSick}</div>
                            <div class="text-sm text-gray-600">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°:</span>
                            <span class="text-xl font-bold text-blue-600">${overallPercentage}%</span>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="font-semibold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°:</span>
                            <span class="font-bold ${overallStatus.includes('‡∏Ç‡∏£') ? 'text-red-600' : 'text-green-600'}">${overallStatus}</span>
                        </div>
                    </div>
                `;
                contentDiv.appendChild(summaryDiv);

                // Subject details
                Object.keys(attendanceBySubject).forEach(subjectCode => {
                    const attendance = attendanceBySubject[subjectCode];
                    const subjectName = subjectsMap[subjectCode] || subjectCode;
                    const totalDays = attendance.present + attendance.absent + attendance.late + attendance.business + attendance.sick;
                    const effectiveAbsent = attendance.absent + Math.floor((attendance.late + attendance.business + attendance.sick) / 2);
                    const percentage = totalDays > 0 ? ((totalDays - effectiveAbsent) / totalDays * 100).toFixed(1) : 0;
                    const status = effectiveAbsent >= 4 ? '‡∏Ç‡∏£ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏™‡∏≠‡∏ö)' : '‡∏õ‡∏Å‡∏ï‡∏¥';

                    const subjectDiv = document.createElement('div');
                    subjectDiv.className = 'bg-white border rounded-lg p-6';
                    subjectDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-bold text-gray-800">üìö ${subjectCode} - ${subjectName}</h4>
                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${status.includes('‡∏Ç‡∏£') ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${status}</span>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
                            <div class="text-center">
                                <div class="text-xl font-bold text-green-600">${attendance.present}</div>
                                <div class="text-sm text-gray-600">‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-red-600">${attendance.absent}</div>
                                <div class="text-sm text-gray-600">‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-yellow-600">${attendance.late}</div>
                                <div class="text-sm text-gray-600">‚è∞ ‡∏™‡∏≤‡∏¢</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-blue-600">${attendance.business}</div>
                                <div class="text-sm text-gray-600">üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-purple-600">${attendance.sick}</div>
                                <div class="text-sm text-gray-600">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                                <span class="text-lg font-bold text-blue-600">${percentage}%</span>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <span class="font-semibold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                                <span class="font-semibold">${totalDays} ‡∏ß‡∏±‡∏ô</span>
                            </div>
                        </div>
                    `;
                    contentDiv.appendChild(subjectDiv);
                });

                if (Object.keys(attendanceBySubject).length === 0) {
                    contentDiv.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-gray-500 text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        }

        function backToStudentManagement() {
            hideAllSections();
            document.getElementById('studentManagement').classList.remove('hidden');
        }

        // Subject Management Functions
        function showAddSubjectForm() {
            document.getElementById('addSubjectForm').classList.remove('hidden');
        }

        function hideAddSubjectForm() {
            document.getElementById('addSubjectForm').classList.add('hidden');
            document.getElementById('subjectCode').value = '';
            document.getElementById('subjectName').value = '';
        }

        async function addSubject(event) {
            event.preventDefault();
            const code = document.getElementById('subjectCode').value.trim();
            const name = document.getElementById('subjectName').value.trim();

            if (!code || !name) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            // Show loading
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                // Check if subject code already exists
                const existingDoc = await db.collection('subjects').doc(code).get();
                if (existingDoc.exists) {
                    Swal.fire({
                        icon: 'error',
                        title: '‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤‡∏ã‡πâ‡∏≥',
                        text: '‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏∑‡πà‡∏ô',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                        confirmButtonColor: '#ef4444'
                    });
                    return;
                }

                await db.collection('subjects').doc(code).set({
                    code: code,
                    name: name,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                hideAddSubjectForm();
                loadSubjects();
                
                Swal.fire({
                    icon: 'success',
                    title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ ${code} - ${name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        async function loadSubjects() {
            try {
                const snapshot = await db.collection('subjects').get();
                subjects = [];
                const tbody = document.getElementById('subjectsTableBody');
                tbody.innerHTML = '';

                snapshot.forEach(doc => {
                    const subject = doc.data();
                    subjects.push(subject);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${subject.code}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${subject.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <button onclick="deleteSubject('${subject.code}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                                ‡∏•‡∏ö
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        async function deleteSubject(code) {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤',
                text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ ${code} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                // Show loading
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    await db.collection('subjects').doc(code).delete();
                    loadSubjects();
                    
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: `‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ ${code} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                        confirmButtonColor: '#ef4444'
                    });
                }
            }
        }

        // Student Management Functions
        function showAddStudentForm() {
            document.getElementById('addStudentForm').classList.remove('hidden');
        }

        function hideAddStudentForm() {
            document.getElementById('addStudentForm').classList.add('hidden');
            document.getElementById('studentCode').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('studentGrade').value = '';
        }

        async function addStudent(event) {
            event.preventDefault();
            const code = document.getElementById('studentCode').value.trim();
            const name = document.getElementById('studentName').value.trim();
            const grade = document.getElementById('studentGrade').value.trim();

            if (!code || !name || !grade) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            // Show loading
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                // Check if student code already exists
                const existingDoc = await db.collection('students').doc(code).get();
                if (existingDoc.exists) {
                    Swal.fire({
                        icon: 'error',
                        title: '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥',
                        text: '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                        confirmButtonColor: '#ef4444'
                    });
                    return;
                }

                await db.collection('students').doc(code).set({
                    code: code,
                    name: name,
                    grade: grade,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                hideAddStudentForm();
                loadStudents();
                
                Swal.fire({
                    icon: 'success',
                    title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${code} - ${name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        async function loadStudents() {
            try {
                const snapshot = await db.collection('students').get();
                students = [];
                const tbody = document.getElementById('studentsTableBody');
                tbody.innerHTML = '';

                snapshot.forEach(doc => {
                    const student = doc.data();
                    students.push(student);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.code}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <button onclick="viewStudentReport('${student.code}', '${student.name}', '${student.grade}')" class="text-blue-600 hover:text-blue-800 font-medium underline">
                                ${student.name}
                            </button>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.grade}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <button onclick="deleteStudent('${student.code}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                                ‡∏•‡∏ö
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function deleteStudent(code) {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™ ${code} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                // Show loading
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    await db.collection('students').doc(code).delete();
                    loadStudents();
                    
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: `‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™ ${code} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                        confirmButtonColor: '#ef4444'
                    });
                }
            }
        }

        // Attendance Functions
        async function loadGrades() {
            try {
                const snapshot = await db.collection('students').get();
                const grades = new Set();
                
                snapshot.forEach(doc => {
                    grades.add(doc.data().grade);
                });

                const select = document.getElementById('gradeSelect');
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>';
                
                Array.from(grades).sort().forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade;
                    option.textContent = grade;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadSubjectsForAttendance() {
            try {
                const snapshot = await db.collection('subjects').get();
                const select = document.getElementById('subjectSelect');
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>';
                
                snapshot.forEach(doc => {
                    const subject = doc.data();
                    const option = document.createElement('option');
                    option.value = subject.code;
                    option.textContent = `${subject.code} - ${subject.name}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadStudentsByGrade() {
            const selectedGrade = document.getElementById('gradeSelect').value;
            if (!selectedGrade) {
                document.getElementById('attendanceList').classList.add('hidden');
                document.getElementById('attendanceRecordsTable').classList.add('hidden');
                document.getElementById('attendanceReport').classList.add('hidden');
                return;
            }

            try {
                const snapshot = await db.collection('students').where('grade', '==', selectedGrade).get();
                const container = document.getElementById('studentsAttendanceList');
                container.innerHTML = '';

                snapshot.forEach(doc => {
                    const student = doc.data();
                    const studentDiv = document.createElement('div');
                    studentDiv.className = 'bg-gray-50 p-4 rounded-lg';
                    studentDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="font-medium">${student.code} - ${student.name}</div>
                            <div class="flex space-x-2">
                                <button onclick="setAttendanceStatus('${student.code}', 'present')" class="attendance-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                                    ‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                                </button>
                                <button onclick="setAttendanceStatus('${student.code}', 'absent')" class="attendance-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                                    ‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                                </button>
                                <button onclick="setAttendanceStatus('${student.code}', 'late')" class="attendance-btn bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                                    ‚è∞ ‡∏™‡∏≤‡∏¢
                                </button>
                                <button onclick="setAttendanceStatus('${student.code}', 'business')" class="attendance-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                                    üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à
                                </button>
                                <button onclick="setAttendanceStatus('${student.code}', 'sick')" class="attendance-btn bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                                    ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢
                                </button>
                            </div>
                        </div>
                        <div id="status-${student.code}" class="mt-2 text-sm text-gray-600"></div>
                    `;
                    container.appendChild(studentDiv);
                });

                document.getElementById('attendanceList').classList.remove('hidden');
                
                // Load existing attendance records if available
                await loadAttendanceRecordsTable();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function setAttendanceStatus(studentCode, status) {
            const statusDiv = document.getElementById(`status-${studentCode}`);
            const statusText = {
                'present': '‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                'absent': '‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                'late': '‚è∞ ‡∏™‡∏≤‡∏¢',
                'business': 'üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à',
                'sick': 'ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢'
            };
            
            statusDiv.textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${statusText[status]}`;
            statusDiv.setAttribute('data-status', status);
        }

        async function saveAttendance() {
            const grade = document.getElementById('gradeSelect').value;
            const subject = document.getElementById('subjectSelect').value;
            const date = document.getElementById('attendanceDate').value;

            if (!grade || !subject || !date) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            const statusDivs = document.querySelectorAll('[id^="status-"]');
            
            // Check if all students have status
            for (let div of statusDivs) {
                const status = div.getAttribute('data-status');
                if (!status) {
                    const studentCode = div.id.replace('status-', '');
                    Swal.fire({
                        icon: 'warning',
                        title: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏ö',
                        text: `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™ ${studentCode}`,
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                        confirmButtonColor: '#3b82f6'
                    });
                    return;
                }
            }

            // Show loading
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const batch = db.batch();
                let checkedCount = 0;
                let totalStudents = statusDivs.length;
                let statusCounts = { present: 0, absent: 0, late: 0, business: 0, sick: 0 };

                // Check if attendance already exists for this date
                const existingAttendance = await db.collection('attendance')
                    .where('subject', '==', subject)
                    .where('grade', '==', grade)
                    .where('date', '==', date)
                    .get();

                // Delete existing records for this date
                existingAttendance.forEach(doc => {
                    batch.delete(doc.ref);
                });

                statusDivs.forEach(div => {
                    const status = div.getAttribute('data-status');
                    if (status) {
                        const studentCode = div.id.replace('status-', '');
                        const docRef = db.collection('attendance').doc();
                        batch.set(docRef, {
                            studentCode: studentCode,
                            subject: subject,
                            grade: grade,
                            date: date,
                            status: status,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        checkedCount++;
                        statusCounts[status]++;
                    }
                });

                await batch.commit();
                
                // Show attendance report
                showAttendanceReport(statusCounts, totalStudents, subject);
                
                // Load attendance records table
                await loadAttendanceRecordsTable();
                
                Swal.fire({
                    icon: 'success',
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    html: `
                        <div class="text-left">
                            <p><strong>‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤:</strong> ${subject}</p>
                            <p><strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</strong> ${grade}</p>
                            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${new Date(date).toLocaleDateString('th-TH')}</p>
                            <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${totalStudents} ‡∏Ñ‡∏ô</p>
                            <div class="mt-2 text-sm">
                                <span class="text-green-600">‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${statusCounts.present}</span> |
                                <span class="text-red-600">‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${statusCounts.absent}</span> |
                                <span class="text-yellow-600">‚è∞ ‡∏™‡∏≤‡∏¢: ${statusCounts.late}</span>
                            </div>
                        </div>
                    `,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#10b981'
                });
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        function showAttendanceReport(statusCounts, totalStudents, subject) {
            const reportDiv = document.getElementById('attendanceReport');
            const contentDiv = document.getElementById('attendanceReportContent');
            
            contentDiv.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                    <div class="text-center">
                        <div class="text-lg font-bold text-green-600">${statusCounts.present}</div>
                        <div class="text-sm">‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-red-600">${statusCounts.absent}</div>
                        <div class="text-sm">‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-yellow-600">${statusCounts.late}</div>
                        <div class="text-sm">‚è∞ ‡∏™‡∏≤‡∏¢</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-blue-600">${statusCounts.business}</div>
                        <div class="text-sm">üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-purple-600">${statusCounts.sick}</div>
                        <div class="text-sm">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-gray-600">${totalStudents}</div>
                        <div class="text-sm">üë• ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-sm text-blue-700">
                        ‡∏ß‡∏¥‡∏ä‡∏≤: ${subject} | ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${((statusCounts.present / totalStudents) * 100).toFixed(1)}%
                    </div>
                </div>
            `;
            
            reportDiv.classList.remove('hidden');
        }

        // Report Functions
        async function loadGradesForReport() {
            try {
                const snapshot = await db.collection('students').get();
                const grades = new Set();
                
                snapshot.forEach(doc => {
                    grades.add(doc.data().grade);
                });

                const select = document.getElementById('reportGradeSelect');
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>';
                
                Array.from(grades).sort().forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade;
                    option.textContent = grade;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadSubjectsForReport() {
            try {
                const snapshot = await db.collection('subjects').get();
                const select = document.getElementById('reportSubjectSelect');
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>';
                
                snapshot.forEach(doc => {
                    const subject = doc.data();
                    const option = document.createElement('option');
                    option.value = subject.code;
                    option.textContent = `${subject.code} - ${subject.name}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadReportData() {
            const grade = document.getElementById('reportGradeSelect').value;
            const subject = document.getElementById('reportSubjectSelect').value;

            if (!grade || !subject) return;

            try {
                // Get students in the selected grade
                const studentsSnapshot = await db.collection('students').where('grade', '==', grade).get();
                
                // Get attendance records for the selected subject
                const attendanceSnapshot = await db.collection('attendance')
                    .where('subject', '==', subject)
                    .where('grade', '==', grade)
                    .get();

                const attendanceData = {};
                attendanceSnapshot.forEach(doc => {
                    const record = doc.data();
                    if (!attendanceData[record.studentCode]) {
                        attendanceData[record.studentCode] = {
                            present: 0,
                            absent: 0,
                            late: 0,
                            business: 0,
                            sick: 0
                        };
                    }
                    attendanceData[record.studentCode][record.status]++;
                });

                const tbody = document.getElementById('reportTableBody');
                tbody.innerHTML = '';

                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    const attendance = attendanceData[student.code] || {
                        present: 0, absent: 0, late: 0, business: 0, sick: 0
                    };

                    // Calculate attendance percentage and status
                    const totalDays = attendance.present + attendance.absent + attendance.late + attendance.business + attendance.sick;
                    const effectiveAbsent = attendance.absent + Math.floor((attendance.late + attendance.business + attendance.sick) / 2);
                    const percentage = totalDays > 0 ? ((totalDays - effectiveAbsent) / totalDays * 100).toFixed(1) : 0;
                    const status = effectiveAbsent >= 4 ? '‡∏Ç‡∏£ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏™‡∏≠‡∏ö)' : '‡∏õ‡∏Å‡∏ï‡∏¥';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.code}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${attendance.present}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${attendance.absent}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${attendance.late}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${attendance.business}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${attendance.sick}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${percentage}%</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${status.includes('‡∏Ç‡∏£') ? 'text-red-600 font-semibold' : 'text-green-600'}">${status}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Student Dashboard Functions
        async function loadStudentDetails(studentData) {
            // Display student details
            const detailsDiv = document.getElementById('studentDetails');
            detailsDiv.innerHTML = `
                <div class="flex justify-between">
                    <span class="font-medium">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                    <span>${studentData.code}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span>
                    <span>${studentData.name}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</span>
                    <span>${studentData.grade}</span>
                </div>
            `;

            // Load attendance data
            await loadStudentAttendanceData(studentData.code);
        }

        async function loadStudentAttendanceData(studentCode) {
            try {
                // Get all subjects
                const subjectsSnapshot = await db.collection('subjects').get();
                const subjectsMap = {};
                subjectsSnapshot.forEach(doc => {
                    const subject = doc.data();
                    subjectsMap[subject.code] = subject.name;
                });

                // Populate subject select dropdown
                const subjectSelect = document.getElementById('studentSubjectSelect');
                subjectSelect.innerHTML = '<option value="">-- ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>';
                Object.keys(subjectsMap).forEach(code => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = `${code} - ${subjectsMap[code]}`;
                    subjectSelect.appendChild(option);
                });

                // Get attendance records for this student
                const attendanceSnapshot = await db.collection('attendance')
                    .where('studentCode', '==', studentCode)
                    .get();

                window.studentAttendanceBySubject = {};
                window.studentSubjectsMap = subjectsMap;

                attendanceSnapshot.forEach(doc => {
                    const record = doc.data();
                    if (!window.studentAttendanceBySubject[record.subject]) {
                        window.studentAttendanceBySubject[record.subject] = {
                            present: 0, absent: 0, late: 0, business: 0, sick: 0
                        };
                    }
                    window.studentAttendanceBySubject[record.subject][record.status]++;
                });

                // Load initial summary (all subjects)
                loadStudentSubjectSummary();
                
                // Load subject reports
                loadStudentSubjectReports();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function loadStudentSubjectSummary() {
            const selectedSubject = document.getElementById('studentSubjectSelect').value;
            const summaryDiv = document.getElementById('attendanceSummary');
            
            let totalPresent = 0, totalAbsent = 0, totalLate = 0, totalBusiness = 0, totalSick = 0;
            
            if (selectedSubject) {
                // Show summary for selected subject only
                const attendance = window.studentAttendanceBySubject[selectedSubject] || {
                    present: 0, absent: 0, late: 0, business: 0, sick: 0
                };
                totalPresent = attendance.present;
                totalAbsent = attendance.absent;
                totalLate = attendance.late;
                totalBusiness = attendance.business;
                totalSick = attendance.sick;
            } else {
                // Show summary for all subjects
                Object.values(window.studentAttendanceBySubject).forEach(attendance => {
                    totalPresent += attendance.present;
                    totalAbsent += attendance.absent;
                    totalLate += attendance.late;
                    totalBusiness += attendance.business;
                    totalSick += attendance.sick;
                });
            }

            const totalDays = totalPresent + totalAbsent + totalLate + totalBusiness + totalSick;
            const effectiveAbsent = totalAbsent + Math.floor((totalLate + totalBusiness + totalSick) / 2);
            const overallPercentage = totalDays > 0 ? ((totalDays - effectiveAbsent) / totalDays * 100).toFixed(1) : 0;
            const overallStatus = effectiveAbsent >= 4 ? '‡∏Ç‡∏£ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏™‡∏≠‡∏ö)' : '‡∏õ‡∏Å‡∏ï‡∏¥';

            const subjectTitle = selectedSubject ? 
                `${selectedSubject} - ${window.studentSubjectsMap[selectedSubject]}` : 
                '‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤';

            summaryDiv.innerHTML = `
                <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                    <div class="text-blue-800 font-semibold text-center">${subjectTitle}</div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-green-100 p-3 rounded-lg">
                        <div class="text-green-800 font-semibold">‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        <div class="text-2xl font-bold text-green-600">${totalPresent}</div>
                    </div>
                    <div class="bg-red-100 p-3 rounded-lg">
                        <div class="text-red-800 font-semibold">‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        <div class="text-2xl font-bold text-red-600">${totalAbsent}</div>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-lg">
                        <div class="text-yellow-800 font-semibold">‚è∞ ‡∏™‡∏≤‡∏¢</div>
                        <div class="text-2xl font-bold text-yellow-600">${totalLate}</div>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <div class="text-blue-800 font-semibold">üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</div>
                        <div class="text-2xl font-bold text-blue-600">${totalBusiness}</div>
                    </div>
                </div>
                <div class="mt-4 p-4 bg-gray-100 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                        <span class="text-xl font-bold">${overallPercentage}%</span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="font-semibold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                        <span class="font-bold ${overallStatus.includes('‡∏Ç‡∏£') ? 'text-red-600' : 'text-green-600'}">${overallStatus}</span>
                    </div>
                </div>
            `;
        }

        function loadStudentSubjectReports() {
            const reportsDiv = document.getElementById('subjectReports');
            reportsDiv.innerHTML = '';

            Object.keys(window.studentAttendanceBySubject).forEach(subjectCode => {
                const attendance = window.studentAttendanceBySubject[subjectCode];
                const subjectName = window.studentSubjectsMap[subjectCode] || subjectCode;
                const totalDays = attendance.present + attendance.absent + attendance.late + attendance.business + attendance.sick;
                const effectiveAbsent = attendance.absent + Math.floor((attendance.late + attendance.business + attendance.sick) / 2);
                const percentage = totalDays > 0 ? ((totalDays - effectiveAbsent) / totalDays * 100).toFixed(1) : 0;
                const status = effectiveAbsent >= 4 ? '‡∏Ç‡∏£ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏™‡∏≠‡∏ö)' : '‡∏õ‡∏Å‡∏ï‡∏¥';

                const reportCard = document.createElement('div');
                reportCard.className = 'bg-white rounded-lg shadow p-6';
                reportCard.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">üìö ${subjectCode} - ${subjectName}</h3>
                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${status.includes('‡∏Ç‡∏£') ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${status}</span>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${attendance.present}</div>
                            <div class="text-sm text-gray-600">‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600">${attendance.absent}</div>
                            <div class="text-sm text-gray-600">‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-600">${attendance.late}</div>
                            <div class="text-sm text-gray-600">‚è∞ ‡∏™‡∏≤‡∏¢</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${attendance.business}</div>
                            <div class="text-sm text-gray-600">üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600">${attendance.sick}</div>
                            <div class="text-sm text-gray-600">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                            <span class="text-xl font-bold text-blue-600">${percentage}%</span>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="font-semibold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                            <span class="font-semibold">${totalDays} ‡∏ß‡∏±‡∏ô</span>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="font-semibold">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤:</span>
                            <span class="font-semibold text-red-600">${effectiveAbsent} ‡∏ß‡∏±‡∏ô</span>
                        </div>
                    </div>
                `;
                reportsDiv.appendChild(reportCard);
            });

            if (Object.keys(window.studentAttendanceBySubject).length === 0) {
                reportsDiv.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-6 text-center">
                        <div class="text-gray-500 text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                    </div>
                `;
            }
        }

        // Attendance History Functions
        async function showAttendanceHistory() {
            const grade = document.getElementById('gradeSelect').value;
            const subject = document.getElementById('subjectSelect').value;

            if (!grade || !subject) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            try {
                const attendanceSnapshot = await db.collection('attendance')
                    .where('subject', '==', subject)
                    .where('grade', '==', grade)
                    .orderBy('date', 'desc')
                    .get();

                const attendanceByDate = {};
                const studentsSnapshot = await db.collection('students').where('grade', '==', grade).get();
                const studentsMap = {};
                
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    studentsMap[student.code] = student.name;
                });

                attendanceSnapshot.forEach(doc => {
                    const record = doc.data();
                    if (!attendanceByDate[record.date]) {
                        attendanceByDate[record.date] = {};
                    }
                    attendanceByDate[record.date][record.studentCode] = {
                        status: record.status,
                        docId: doc.id
                    };
                });

                const contentDiv = document.getElementById('attendanceHistoryContent');
                contentDiv.innerHTML = '';

                if (Object.keys(attendanceByDate).length === 0) {
                    contentDiv.innerHTML = '<div class="text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</div>';
                } else {
                    Object.keys(attendanceByDate).forEach(date => {
                        const dateDiv = document.createElement('div');
                        dateDiv.className = 'mb-6 border rounded-lg p-4';
                        
                        const dateHeader = document.createElement('div');
                        dateHeader.className = 'flex justify-between items-center mb-4 pb-2 border-b';
                        dateHeader.innerHTML = `
                            <h4 class="font-bold text-lg">üìÖ ${new Date(date).toLocaleDateString('th-TH')}</h4>
                            <div class="text-sm text-gray-600">${subject}</div>
                        `;
                        dateDiv.appendChild(dateHeader);

                        const studentsGrid = document.createElement('div');
                        studentsGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3';

                        Object.keys(studentsMap).forEach(studentCode => {
                            const studentName = studentsMap[studentCode];
                            const attendance = attendanceByDate[date][studentCode];
                            
                            const studentDiv = document.createElement('div');
                            studentDiv.className = 'bg-gray-50 p-3 rounded flex justify-between items-center';
                            
                            const statusText = {
                                'present': '‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                                'absent': '‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                                'late': '‚è∞ ‡∏™‡∏≤‡∏¢',
                                'business': 'üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à',
                                'sick': 'ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢'
                            };

                            const currentStatus = attendance ? attendance.status : 'absent';
                            const docId = attendance ? attendance.docId : null;

                            studentDiv.innerHTML = `
                                <div>
                                    <div class="font-medium">${studentCode}</div>
                                    <div class="text-sm text-gray-600">${studentName}</div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <select onchange="updateAttendanceStatus('${docId}', '${studentCode}', '${date}', '${subject}', '${grade}', this.value)" class="text-sm border rounded px-2 py-1">
                                        <option value="present" ${currentStatus === 'present' ? 'selected' : ''}>‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                                        <option value="absent" ${currentStatus === 'absent' ? 'selected' : ''}>‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                                        <option value="late" ${currentStatus === 'late' ? 'selected' : ''}>‚è∞ ‡∏™‡∏≤‡∏¢</option>
                                        <option value="business" ${currentStatus === 'business' ? 'selected' : ''}>üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
                                        <option value="sick" ${currentStatus === 'sick' ? 'selected' : ''}>ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option>
                                    </select>
                                </div>
                            `;
                            studentsGrid.appendChild(studentDiv);
                        });

                        dateDiv.appendChild(studentsGrid);
                        contentDiv.appendChild(dateDiv);
                    });
                }

                document.getElementById('attendanceHistoryModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥');
            }
        }

        async function updateAttendanceStatus(docId, studentCode, date, subject, grade, newStatus) {
            try {
                if (docId) {
                    // Update existing record
                    await db.collection('attendance').doc(docId).update({
                        status: newStatus,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // Create new record
                    await db.collection('attendance').add({
                        studentCode: studentCode,
                        subject: subject,
                        grade: grade,
                        date: date,
                        status: newStatus,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Show success toast
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });
                
                Toast.fire({
                    icon: 'success',
                    title: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${studentCode} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`
                });
                
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        function closeAttendanceHistory() {
            document.getElementById('attendanceHistoryModal').classList.add('hidden');
        }

        // Attendance Records Table Functions
        async function loadAttendanceRecordsTable() {
            const grade = document.getElementById('gradeSelect').value;
            
            if (!grade) return;

            try {
                // Get filter values
                const dateFilter = document.getElementById('tableDateFilter').value;
                const subjectFilter = document.getElementById('tableSubjectFilter').value;
                const statusFilter = document.getElementById('tableStatusFilter').value;
                const sortOrder = document.getElementById('tableSortOrder').value;

                // Build query
                let query = db.collection('attendance').where('grade', '==', grade);
                
                if (dateFilter) {
                    query = query.where('date', '==', dateFilter);
                }
                
                if (subjectFilter) {
                    query = query.where('subject', '==', subjectFilter);
                }
                
                if (statusFilter) {
                    query = query.where('status', '==', statusFilter);
                }

                const attendanceSnapshot = await query.get();

                // Get student names and subjects
                const studentsSnapshot = await db.collection('students').where('grade', '==', grade).get();
                const studentsMap = {};
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    studentsMap[student.code] = student.name;
                });

                const subjectsSnapshot = await db.collection('subjects').get();
                const subjectsMap = {};
                subjectsSnapshot.forEach(doc => {
                    const subject = doc.data();
                    subjectsMap[subject.code] = subject.name;
                });

                // Populate subject filter dropdown
                const subjectFilterSelect = document.getElementById('tableSubjectFilter');
                if (subjectFilterSelect.children.length <= 1) {
                    subjectsSnapshot.forEach(doc => {
                        const subject = doc.data();
                        const option = document.createElement('option');
                        option.value = subject.code;
                        option.textContent = `${subject.code} - ${subject.name}`;
                        subjectFilterSelect.appendChild(option);
                    });
                }

                // Collect and sort records
                const records = [];
                attendanceSnapshot.forEach(doc => {
                    const record = doc.data();
                    records.push({
                        id: doc.id,
                        ...record,
                        studentName: studentsMap[record.studentCode] || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠',
                        subjectName: subjectsMap[record.subject] || record.subject
                    });
                });

                // Sort records
                records.sort((a, b) => {
                    switch (sortOrder) {
                        case 'desc':
                            return b.studentCode.localeCompare(a.studentCode);
                        case 'name_asc':
                            return a.studentName.localeCompare(b.studentName, 'th');
                        case 'name_desc':
                            return b.studentName.localeCompare(a.studentName, 'th');
                        default: // 'asc'
                            return a.studentCode.localeCompare(b.studentCode);
                    }
                });

                const tbody = document.getElementById('attendanceRecordsTableBody');
                tbody.innerHTML = '';

                if (records.length === 0) {
                    const filterInfo = [];
                    if (dateFilter) filterInfo.push(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(dateFilter).toLocaleDateString('th-TH')}`);
                    if (subjectFilter) filterInfo.push(`‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤: ${subjectFilter}`);
                    if (statusFilter) filterInfo.push(`‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${statusFilter}`);
                    
                    const filterText = filterInfo.length > 0 ? 
                        `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ${filterInfo.join(', ')}` : 
                        '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠';
                    
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                ${filterText}
                            </td>
                        </tr>
                    `;
                } else {
                    const statusText = {
                        'present': { text: '‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', color: 'text-green-600' },
                        'absent': { text: '‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', color: 'text-red-600' },
                        'late': { text: '‚è∞ ‡∏™‡∏≤‡∏¢', color: 'text-yellow-600' },
                        'business': { text: 'üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à', color: 'text-blue-600' },
                        'sick': { text: 'ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', color: 'text-purple-600' }
                    };

                    records.forEach(record => {
                        const timestamp = record.timestamp ? record.timestamp.toDate().toLocaleString('th-TH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                        const statusInfo = statusText[record.status] || { text: record.status, color: 'text-gray-600' };
                        const displayDate = record.date ? new Date(record.date).toLocaleDateString('th-TH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${record.studentCode}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${record.studentName}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${record.subject} - ${record.subjectName}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${displayDate}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium ${statusInfo.color}">${statusInfo.text}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${timestamp}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                                <div class="flex space-x-2">
                                    <select onchange="updateSingleAttendanceStatus('${record.id}', this.value)" class="text-xs border rounded px-2 py-1">
                                        <option value="present" ${record.status === 'present' ? 'selected' : ''}>‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                                        <option value="absent" ${record.status === 'absent' ? 'selected' : ''}>‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                                        <option value="late" ${record.status === 'late' ? 'selected' : ''}>‚è∞ ‡∏™‡∏≤‡∏¢</option>
                                        <option value="business" ${record.status === 'business' ? 'selected' : ''}>üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
                                        <option value="sick" ${record.status === 'sick' ? 'selected' : ''}>ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option>
                                    </select>
                                    <button onclick="deleteSingleAttendanceRecord('${record.id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">
                                        ‡∏•‡∏ö
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                // Show the table
                document.getElementById('attendanceRecordsTable').classList.remove('hidden');

            } catch (error) {
                console.error('Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠');
            }
        }

        // Table sorting function
        let currentSort = { column: '', direction: 'asc' };
        
        function sortTable(column) {
            const sortOrder = document.getElementById('tableSortOrder');
            
            if (column === 'studentCode') {
                if (currentSort.column === 'studentCode' && currentSort.direction === 'asc') {
                    sortOrder.value = 'desc';
                    currentSort.direction = 'desc';
                } else {
                    sortOrder.value = 'asc';
                    currentSort.direction = 'asc';
                }
            } else if (column === 'studentName') {
                if (currentSort.column === 'studentName' && currentSort.direction === 'asc') {
                    sortOrder.value = 'name_desc';
                    currentSort.direction = 'desc';
                } else {
                    sortOrder.value = 'name_asc';
                    currentSort.direction = 'asc';
                }
            }
            
            currentSort.column = column;
            
            // Update sort indicators
            document.getElementById('sort-studentCode').textContent = 
                currentSort.column === 'studentCode' ? (currentSort.direction === 'asc' ? '‚Üë' : '‚Üì') : '‚ÜïÔ∏è';
            document.getElementById('sort-studentName').textContent = 
                currentSort.column === 'studentName' ? (currentSort.direction === 'asc' ? '‚Üë' : '‚Üì') : '‚ÜïÔ∏è';
            
            loadAttendanceRecordsTable();
        }

        async function updateSingleAttendanceStatus(docId, newStatus) {
            try {
                await db.collection('attendance').doc(docId).update({
                    status: newStatus,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Show success toast
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 1500,
                    timerProgressBar: true
                });
                
                Toast.fire({
                    icon: 'success',
                    title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'
                });
                
                // Refresh the table and report
                await loadAttendanceRecordsTable();
                await refreshAttendanceReport();
                
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        async function deleteSingleAttendanceRecord(docId) {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                // Show loading
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    await db.collection('attendance').doc(docId).delete();
                    
                    // Show success toast
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });
                    
                    Toast.fire({
                        icon: 'success',
                        title: '‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'
                    });
                    
                    // Refresh the table and report
                    await loadAttendanceRecordsTable();
                    await refreshAttendanceReport();
                    
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                        confirmButtonColor: '#ef4444'
                    });
                }
            }
        }

        async function deleteAllAttendanceForDate() {
            const grade = document.getElementById('gradeSelect').value;
            const subject = document.getElementById('subjectSelect').value;
            const date = document.getElementById('attendanceDate').value;

            if (!grade || !subject || !date) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                html: `
                    <div class="text-left">
                        <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                        <div class="mt-3 p-3 bg-gray-100 rounded">
                            <p><strong>‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤:</strong> ${subject}</p>
                            <p><strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</strong> ${grade}</p>
                            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${new Date(date).toLocaleDateString('th-TH')}</p>
                        </div>
                        <p class="mt-3 text-red-600 text-sm">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: '‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                // Show loading
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    const attendanceSnapshot = await db.collection('attendance')
                        .where('subject', '==', subject)
                        .where('grade', '==', grade)
                        .where('date', '==', date)
                        .get();

                    const batch = db.batch();
                    let deleteCount = 0;
                    attendanceSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                        deleteCount++;
                    });

                    await batch.commit();
                    
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: `‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${deleteCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Hide the table and report
                    document.getElementById('attendanceRecordsTable').classList.add('hidden');
                    document.getElementById('attendanceReport').classList.add('hidden');
                    
                    // Clear status indicators
                    const statusDivs = document.querySelectorAll('[id^="status-"]');
                    statusDivs.forEach(div => {
                        div.textContent = '';
                        div.removeAttribute('data-status');
                    });
                    
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                        confirmButtonColor: '#ef4444'
                    });
                }
            }
        }

        async function refreshAttendanceTable() {
            // Show loading toast
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 1000,
                timerProgressBar: true
            });
            
            Toast.fire({
                icon: 'info',
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'
            });

            await loadAttendanceRecordsTable();
            await refreshAttendanceReport();
            
            // Show success toast
            setTimeout(() => {
                Toast.fire({
                    icon: 'success',
                    title: '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'
                });
            }, 1000);
        }

        async function refreshAttendanceReport() {
            const grade = document.getElementById('gradeSelect').value;
            const subject = document.getElementById('subjectSelect').value;
            const date = document.getElementById('attendanceDate').value;

            if (!grade || !subject || !date) return;

            try {
                const attendanceSnapshot = await db.collection('attendance')
                    .where('subject', '==', subject)
                    .where('grade', '==', grade)
                    .where('date', '==', date)
                    .get();

                const statusCounts = { present: 0, absent: 0, late: 0, business: 0, sick: 0 };
                let totalStudents = 0;

                attendanceSnapshot.forEach(doc => {
                    const record = doc.data();
                    statusCounts[record.status]++;
                    totalStudents++;
                });

                if (totalStudents > 0) {
                    showAttendanceReport(statusCounts, totalStudents, subject);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Quick filter functions for attendance table
        function setTableDateToToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tableDateFilter').value = today;
            loadAttendanceRecordsTable();
        }

        function setTableDateToYesterday() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('tableDateFilter').value = yesterday.toISOString().split('T')[0];
            loadAttendanceRecordsTable();
        }

        function clearTableFilters() {
            document.getElementById('tableDateFilter').value = '';
            document.getElementById('tableSubjectFilter').value = '';
            document.getElementById('tableStatusFilter').value = '';
            document.getElementById('tableSortOrder').value = 'asc';
            loadAttendanceRecordsTable();
        }



        // Export Functions
        function exportReport() {
            const grade = document.getElementById('reportGradeSelect').value;
            const subject = document.getElementById('reportSubjectSelect').value;

            if (!grade || !subject) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            const rows = document.getElementById('reportTableBody').getElementsByTagName('tr');
            if (rows.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å',
                    text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            // Show loading
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                // Add BOM for UTF-8 encoding to support Thai characters
                const BOM = '\uFEFF';
                
                // Create CSV content with proper Thai encoding
                let csvContent = BOM + "‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏™‡∏≤‡∏¢,‡∏•‡∏≤‡∏Å‡∏¥‡∏à,‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢,‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n";
                
                for (let row of rows) {
                    const cells = row.getElementsByTagName('td');
                    const rowData = [];
                    for (let cell of cells) {
                        // Clean and escape CSV data
                        let cellText = cell.textContent.trim();
                        // Escape commas and quotes in CSV
                        if (cellText.includes(',') || cellText.includes('"') || cellText.includes('\n')) {
                            cellText = '"' + cellText.replace(/"/g, '""') + '"';
                        }
                        rowData.push(cellText);
                    }
                    csvContent += rowData.join(',') + '\n';
                }

                // Create and download file
                const blob = new Blob([csvContent], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                
                // Create download link
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                // Generate filename with current date and time
                const now = new Date();
                const dateStr = now.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\//g, '-');
                const timeStr = now.toLocaleTimeString('th-TH', {
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(/:/g, '-');
                
                const fileName = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô_${grade}_${subject}_${dateStr}_${timeStr}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                
                // Add to DOM, click, and remove
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up the URL object
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 100);

                // Show success message
                setTimeout(() => {
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        html: `
                            <div class="text-left">
                                <p><strong>‡πÑ‡∏ü‡∏•‡πå:</strong> ${fileName}</p>
                                <p><strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</strong> ${grade}</p>
                                <p><strong>‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤:</strong> ${subject}</p>
                                <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${rows.length} ‡∏Ñ‡∏ô</p>
                                <div class="mt-3 p-3 bg-green-50 rounded-lg">
                                    <p class="text-green-700 text-sm">
                                        üìÅ ‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Downloads ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß<br>
                                        üí° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ Excel ‡∏´‡∏£‡∏∑‡∏≠ Google Sheets ‡πÑ‡∏î‡πâ
                                    </p>
                                </div>
                            </div>
                        `,
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                        confirmButtonColor: '#10b981'
                    });
                }, 500);

            } catch (error) {
                console.error('Export error:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏≠‡∏∑‡πà‡∏ô',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        // Initialize data loading
        async function loadInitialData() {
            try {
                await loadSubjects();
                await loadStudents();
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'978e037741532603',t:'MTc1NjgyNjY1OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
