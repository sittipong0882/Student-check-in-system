<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üéì</div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
                <p class="text-gray-600">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô 9</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="showAdminLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    üë®‚Äçüè´ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π/‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
                </button>
                <button onclick="showStudentLogin()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    üë©‚Äçüéì ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="adminLoginScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üë®‚Äçüè´</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π</h2>
                <div class="text-sm text-gray-500">‡πÉ‡∏ä‡πâ Admin / 1234 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏•‡∏≠‡∏á</div>
            </div>
            
            <form onsubmit="adminLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                    <input type="text" id="adminUsername" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" required>
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="adminPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
                <button type="button" onclick="backToLogin()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                </button>
            </form>
        </div>
    </div>

    <!-- Student Login -->
    <div id="studentLoginScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üë©‚Äçüéì</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <div class="text-sm text-gray-500">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
            </div>
            
            <form onsubmit="studentLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <input type="text" id="studentId" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" required>
                    <div class="text-xs text-gray-500 mt-1">üí° ‡∏ó‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ: 001, 002, 003</div>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
                <button type="button" onclick="backToLogin()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üë®‚Äçüè´</span>
                        <h1 class="text-2xl font-bold text-gray-900">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏π</h1>
                    </div>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200">
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-blue-600 text-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button onclick="showSubjectManagement()" class="py-4 px-2 border-b-2 border-transparent hover:border-white transition duration-200">
                        üìö ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤
                    </button>
                    <button onclick="showStudentManagement()" class="py-4 px-2 border-b-2 border-transparent hover:border-white transition duration-200">
                        üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    </button>
                    <button onclick="showAttendanceManagement()" class="py-4 px-2 border-b-2 border-transparent hover:border-white transition duration-200">
                        ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
                    </button>
                    <button onclick="showAttendanceHistory()" class="py-4 px-2 border-b-2 border-transparent hover:border-white transition duration-200">
                        üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
                    </button>
                    <button onclick="showReports()" class="py-4 px-2 border-b-2 border-transparent hover:border-white transition duration-200">
                        üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•
                    </button>
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Subject Management -->
            <div id="subjectManagement" class="hidden">
                <div class="bg-white rounded-lg shadow p-6 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">üìö ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h2>
                        <button onclick="showAddSubjectForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤
                        </button>
                    </div>
                    
                    <!-- Add Subject Form -->
                    <div id="addSubjectForm" class="hidden mb-6 p-4 bg-blue-50 rounded-lg slide-in">
                        <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                        <form onsubmit="addSubject(event)" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤</label>
                                <input type="text" id="subjectCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</label>
                                <input type="text" id="subjectName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï</label>
                                <input type="number" id="subjectCredits" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" min="1" max="6" value="3">
                            </div>
                            <div class="md:col-span-3">
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200 mr-2">
                                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                </button>
                                <button type="button" onclick="hideAddSubjectForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Subjects List -->
                    <div id="subjectsList" class="overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="subjectsTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Student Management -->
            <div id="studentManagement" class="hidden">
                <div class="bg-white rounded-lg shadow p-6 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                        <button onclick="showAddStudentForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        </button>
                    </div>
                    
                    <!-- Grade Filter -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-medium mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                        <select id="studentGradeFilter" onchange="filterStudentsByGrade()" class="w-full md:w-64 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="">-- ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>
                        </select>
                    </div>
                    
                    <!-- Add Student Form -->
                    <div id="addStudentForm" class="hidden mb-6 p-4 bg-green-50 rounded-lg slide-in">
                        <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                        <form onsubmit="addStudent(event)" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                <input type="text" id="studentCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                <input type="text" id="studentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                                <input type="text" id="studentGrade" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                            </div>
                            <div class="md:col-span-3">
                                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 mr-2">
                                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                </button>
                                <button type="button" onclick="hideAddStudentForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Edit Student Form -->
                    <div id="editStudentForm" class="hidden mb-6 p-4 bg-blue-50 rounded-lg slide-in">
                        <h3 class="text-lg font-semibold mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                        <form onsubmit="updateStudent(event)" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                <input type="text" id="editStudentCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                <input type="text" id="editStudentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                                <input type="text" id="editStudentGrade" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div class="md:col-span-3">
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200 mr-2">
                                    ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                                </button>
                                <button type="button" onclick="hideEditStudentForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Students List -->
                    <div id="studentsList" class="overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Attendance Management -->
            <div id="attendanceManagement" class="hidden">
                <div class="bg-white rounded-lg shadow p-6 fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                    
                    <!-- Selection Controls -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                            <select id="gradeSelect" onchange="loadStudentsByGrade()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</label>
                            <select id="subjectSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="date" id="attendanceDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <!-- Attendance List -->
                    <div id="attendanceList" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                            <button id="saveAttendanceBtn" onclick="saveAttendance()" disabled class="bg-gray-400 text-white px-4 py-2 rounded-lg transition duration-200 cursor-not-allowed">
                                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
                            </button>
                        </div>
                        <div id="studentsAttendanceList" class="space-y-3">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports -->
            <div id="reports" class="hidden">
                <div class="bg-white rounded-lg shadow p-6 fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                    
                    <!-- Filter Controls -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                            <select id="reportGradeSelect" onchange="loadReportData()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</label>
                            <select id="reportSubjectSelect" onchange="loadReportData()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="date" id="reportDate" onchange="loadReportData()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <!-- Export Controls -->
                    <div class="flex justify-between items-center mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
                        <div>
                            <h3 class="text-lg font-semibold text-green-800 mb-1">üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                            <p class="text-green-600 text-sm">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel</p>
                        </div>
                        <button id="exportExcelBtn" onclick="exportToExcel()" disabled class="bg-gray-400 text-white px-6 py-3 rounded-lg transition duration-200 cursor-not-allowed flex items-center space-x-2">
                            <span>üì•</span>
                            <span>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</span>
                        </button>
                    </div>

                    <div id="reportData" class="overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Attendance History -->
            <div id="attendanceHistory" class="hidden">
                <div class="bg-white rounded-lg shadow p-6 fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h2>
                    
                    <!-- Search Filters -->
                    <div class="p-4 bg-gray-50 rounded-lg mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                            <button onclick="clearAllFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200 text-sm">
                                üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="date" id="historyDateFilter" onchange="filterAttendanceHistory()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</label>
                                <select id="historySubjectFilter" onchange="filterAttendanceHistory()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">-- ‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                                <select id="historyGradeFilter" onchange="filterAttendanceHistory()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">-- ‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                <input type="text" id="historyStudentFilter" onchange="filterAttendanceHistory()" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Bulk Actions -->
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-4">
                            <button id="selectAllBtn" onclick="toggleSelectAll()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-200 text-sm">
                                ‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </button>
                            <button id="bulkDeleteBtn" onclick="bulkDeleteRecords()" disabled class="bg-red-400 text-white px-4 py-2 rounded-lg transition duration-200 text-sm cursor-not-allowed">
                                üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (0)
                            </button>
                        </div>
                    </div>

                    <!-- History Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" class="rounded">
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Edit Attendance Modal -->
            <div id="editAttendanceModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                        <div id="editAttendanceInfo" class="mb-4 p-3 bg-gray-50 rounded">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 font-medium mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà</label>
                            <select id="newAttendanceStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="present">‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                                <option value="absent">‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                                <option value="late">‚è∞ ‡∏™‡∏≤‡∏¢</option>
                                <option value="business">üìã ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
                                <option value="sick">üè• ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option>
                            </select>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button onclick="closeEditAttendanceModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition duration-200">
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                            <button onclick="updateAttendanceStatus()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition duration-200">
                                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Individual Student Report -->
            <div id="individualStudentReport" class="hidden">
                <div class="bg-white rounded-lg shadow p-6 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">üë§ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h2>
                        <button onclick="backToStudentManagement()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö
                        </button>
                    </div>
                    
                    <!-- Student Info Card -->
                    <div id="individualStudentInfo" class="bg-blue-50 p-6 rounded-lg mb-6">
                    </div>

                    <!-- Attendance Summary -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-green-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-green-800 mb-4">üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°</h3>
                            <div id="overallSummary" class="space-y-2">
                            </div>
                        </div>
                        <div class="bg-purple-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-purple-800 mb-4">üìö ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h3>
                            <div id="subjectSummary" class="space-y-3">
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Records -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full table-auto bg-white rounded-lg">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                    </tr>
                                </thead>
                                <tbody id="individualRecordsTable" class="divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Student Dashboard -->
    <div id="studentDashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-green-600 text-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üë©‚Äçüéì</span>
                        <div>
                            <h1 class="text-2xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
                            <span id="studentInfo" class="text-green-100"></span>
                        </div>
                    </div>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200">
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>
        </header>

        <!-- Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Student Info -->
                <div class="bg-white rounded-lg shadow p-6 fade-in">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
                    <div id="studentDetails" class="space-y-3">
                    </div>
                </div>

                <!-- Attendance Summary -->
                <div class="lg:col-span-2 bg-white rounded-lg shadow p-6 fade-in">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                    <div id="attendanceSummary" class="space-y-4">
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBcgffOPz842O-EAD2Hj8RyOpt08MJyzwc",
            authDomain: "student-check-in-system-86d39.firebaseapp.com",
            projectId: "student-check-in-system-86d39",
            storageBucket: "student-check-in-system-86d39.firebasestorage.app",
            messagingSenderId: "775189689512",
            appId: "1:775189689512:web:fb49659c49d33fde93be9d",
            measurementId: "G-PVC8XHXEFC"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let currentUserType = null;
        let subjects = [];
        let students = [];
        let attendanceRecords = [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
        });

        // Login Functions
        function showAdminLogin() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminLoginScreen').classList.remove('hidden');
        }

        function showStudentLogin() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('studentLoginScreen').classList.remove('hidden');
        }

        function backToLogin() {
            document.getElementById('adminLoginScreen').classList.add('hidden');
            document.getElementById('studentLoginScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function adminLogin(event) {
            event.preventDefault();
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;

            if (username === 'Admin' && password === '1234') {
                currentUser = 'admin';
                currentUserType = 'admin';
                
                Swal.fire({
                    icon: 'success',
                    title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    showAdminDashboard();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                    confirmButtonText: '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'
                });
            }
        }

        async function studentLogin(event) {
            event.preventDefault();
            const studentId = document.getElementById('studentId').value;

            try {
                const studentDoc = await db.collection('students').doc(studentId).get();
                if (studentDoc.exists) {
                    currentUser = studentId;
                    currentUserType = 'student';
                    
                    Swal.fire({
                        icon: 'success',
                        title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${studentDoc.data().name}`,
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        showStudentDashboard(studentDoc.data());
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                        text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
                        confirmButtonText: '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
            }
        }

        function logout() {
            currentUser = null;
            currentUserType = null;
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('studentDashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Reset forms
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('studentId').value = '';
        }

        // Dashboard Functions
        function showAdminDashboard() {
            document.getElementById('adminLoginScreen').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            showSubjectManagement(); // Show first tab by default
            loadSubjects();
            loadStudents();
        }

        async function showStudentDashboard(studentData) {
            document.getElementById('studentLoginScreen').classList.add('hidden');
            document.getElementById('studentDashboard').classList.remove('hidden');
            
            // Display student info
            document.getElementById('studentInfo').textContent = `${studentData.name} (${studentData.grade})`;
            
            // Load student details
            await loadStudentDetails(studentData);
        }

        // Navigation Functions
        function showSubjectManagement() {
            hideAllSections();
            document.getElementById('subjectManagement').classList.remove('hidden');
            loadSubjects();
        }

        function showStudentManagement() {
            hideAllSections();
            document.getElementById('studentManagement').classList.remove('hidden');
            loadStudents();
        }

        function showAttendanceManagement() {
            hideAllSections();
            document.getElementById('attendanceManagement').classList.remove('hidden');
            loadGrades();
            loadSubjectsForAttendance();
        }

        function showAttendanceHistory() {
            hideAllSections();
            document.getElementById('attendanceHistory').classList.remove('hidden');
            loadAttendanceHistory();
        }

        function showReports() {
            hideAllSections();
            document.getElementById('reports').classList.remove('hidden');
            loadGradesForReport();
            loadSubjectsForReport();
        }

        function hideAllSections() {
            const sections = ['subjectManagement', 'studentManagement', 'attendanceManagement', 'attendanceHistory', 'reports', 'individualStudentReport'];
            sections.forEach(section => {
                document.getElementById(section).classList.add('hidden');
            });
        }

        // Subject Management Functions
        function showAddSubjectForm() {
            document.getElementById('addSubjectForm').classList.remove('hidden');
        }

        function hideAddSubjectForm() {
            document.getElementById('addSubjectForm').classList.add('hidden');
            document.getElementById('subjectCode').value = '';
            document.getElementById('subjectName').value = '';
            document.getElementById('subjectCredits').value = '3';
        }

        async function addSubject(event) {
            event.preventDefault();
            const code = document.getElementById('subjectCode').value;
            const name = document.getElementById('subjectName').value;
            const credits = parseInt(document.getElementById('subjectCredits').value);

            try {
                await db.collection('subjects').doc(code).set({
                    code: code,
                    name: name,
                    credits: credits,
                    createdAt: new Date()
                });

                Swal.fire({
                    icon: 'success',
                    title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ ${name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                    timer: 1500,
                    showConfirmButton: false
                });

                hideAddSubjectForm();
                loadSubjects();
            } catch (error) {
                console.error('Error adding subject:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏î‡πâ',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
            }
        }

        async function loadSubjects() {
            try {
                const snapshot = await db.collection('subjects').orderBy('code').get();
                subjects = [];
                const tbody = document.getElementById('subjectsTableBody');
                tbody.innerHTML = '';

                snapshot.forEach(doc => {
                    const subject = doc.data();
                    subjects.push(subject);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${subject.code}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${subject.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${subject.credits}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="deleteSubject('${subject.code}')" class="text-red-600 hover:text-red-900">‡∏•‡∏ö</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading subjects:', error);
            }
        }

        async function deleteSubject(code) {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ ${code} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#ef4444'
            });

            if (result.isConfirmed) {
                try {
                    await db.collection('subjects').doc(code).delete();
                    
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        timer: 1500,
                        showConfirmButton: false
                    });

                    loadSubjects();
                } catch (error) {
                    console.error('Error deleting subject:', error);
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏î‡πâ',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                    });
                }
            }
        }

        // Student Management Functions
        function showAddStudentForm() {
            document.getElementById('addStudentForm').classList.remove('hidden');
        }

        function hideAddStudentForm() {
            document.getElementById('addStudentForm').classList.add('hidden');
            document.getElementById('studentCode').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('studentGrade').value = '';
        }

        function showEditStudentForm() {
            document.getElementById('editStudentForm').classList.remove('hidden');
        }

        function hideEditStudentForm() {
            document.getElementById('editStudentForm').classList.add('hidden');
            document.getElementById('editStudentCode').value = '';
            document.getElementById('editStudentName').value = '';
            document.getElementById('editStudentGrade').value = '';
        }

        async function editStudent(studentCode) {
            try {
                const studentDoc = await db.collection('students').doc(studentCode).get();
                if (studentDoc.exists) {
                    const student = studentDoc.data();
                    document.getElementById('editStudentCode').value = student.code;
                    document.getElementById('editStudentName').value = student.name;
                    document.getElementById('editStudentGrade').value = student.grade;
                    showEditStudentForm();
                }
            } catch (error) {
                console.error('Error loading student for edit:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
            }
        }

        async function updateStudent(event) {
            event.preventDefault();
            const code = document.getElementById('editStudentCode').value;
            const name = document.getElementById('editStudentName').value;
            const grade = document.getElementById('editStudentGrade').value;

            try {
                await db.collection('students').doc(code).update({
                    name: name,
                    grade: grade,
                    updatedAt: new Date()
                });

                Swal.fire({
                    icon: 'success',
                    title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                    timer: 1500,
                    showConfirmButton: false
                });

                hideEditStudentForm();
                loadStudents();
            } catch (error) {
                console.error('Error updating student:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
            }
        }

        function filterStudentsByGrade() {
            const selectedGrade = document.getElementById('studentGradeFilter').value;
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';

            let filteredStudents = students;
            if (selectedGrade) {
                filteredStudents = students.filter(student => student.grade === selectedGrade);
            }

            filteredStudents.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.code}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <button onclick="viewStudentReport('${student.code}')" class="text-blue-600 hover:text-blue-800 hover:underline font-medium">
                            ${student.name}
                        </button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.grade}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editStudent('${student.code}')" class="text-blue-600 hover:text-blue-900 mr-3">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="deleteStudent('${student.code}')" class="text-red-600 hover:text-red-900">‡∏•‡∏ö</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function addStudent(event) {
            event.preventDefault();
            const code = document.getElementById('studentCode').value;
            const name = document.getElementById('studentName').value;
            const grade = document.getElementById('studentGrade').value;

            try {
                await db.collection('students').doc(code).set({
                    code: code,
                    name: name,
                    grade: grade,
                    createdAt: new Date()
                });

                Swal.fire({
                    icon: 'success',
                    title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                    timer: 1500,
                    showConfirmButton: false
                });

                hideAddStudentForm();
                loadStudents();
            } catch (error) {
                console.error('Error adding student:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
            }
        }

        async function loadStudents() {
            try {
                const snapshot = await db.collection('students').orderBy('code').get();
                students = [];

                snapshot.forEach(doc => {
                    const student = doc.data();
                    students.push(student);
                });

                // Update grade select options
                updateGradeOptions();
                updateStudentGradeFilter();
                
                // Display all students initially
                filterStudentsByGrade();
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        function updateStudentGradeFilter() {
            const grades = [...new Set(students.map(s => s.grade))].sort();
            const select = document.getElementById('studentGradeFilter');
            
            if (select) {
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>';
                grades.forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade;
                    option.textContent = grade;
                    select.appendChild(option);
                });
                select.value = currentValue;
            }
        }

        async function deleteStudent(code) {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™ ${code} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#ef4444'
            });

            if (result.isConfirmed) {
                try {
                    await db.collection('students').doc(code).delete();
                    
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: '‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        timer: 1500,
                        showConfirmButton: false
                    });

                    loadStudents();
                } catch (error) {
                    console.error('Error deleting student:', error);
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                    });
                }
            }
        }

        // Attendance Management Functions
        function updateGradeOptions() {
            const grades = [...new Set(students.map(s => s.grade))].sort();
            const gradeSelects = ['gradeSelect', 'reportGradeSelect'];
            
            gradeSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>';
                    grades.forEach(grade => {
                        const option = document.createElement('option');
                        option.value = grade;
                        option.textContent = grade;
                        select.appendChild(option);
                    });
                    select.value = currentValue;
                }
            });
        }

        async function loadGrades() {
            await loadStudents();
        }

        async function loadSubjectsForAttendance() {
            await loadSubjects();
            const select = document.getElementById('subjectSelect');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.code;
                option.textContent = `${subject.code} - ${subject.name}`;
                select.appendChild(option);
            });
        }

        async function loadStudentsByGrade() {
            const grade = document.getElementById('gradeSelect').value;
            if (!grade) {
                document.getElementById('attendanceList').classList.add('hidden');
                return;
            }

            const gradeStudents = students.filter(s => s.grade === grade);
            const container = document.getElementById('studentsAttendanceList');
            container.innerHTML = '';

            gradeStudents.forEach(student => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div>
                        <div class="font-medium">${student.name}</div>
                        <div class="text-sm text-gray-500">‡∏£‡∏´‡∏±‡∏™: ${student.code}</div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="setAttendanceStatus('${student.code}', 'present')" 
                                class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition duration-200 text-sm">
                            ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        </button>
                        <button onclick="setAttendanceStatus('${student.code}', 'absent')" 
                                class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition duration-200 text-sm">
                            ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        </button>
                        <button onclick="setAttendanceStatus('${student.code}', 'late')" 
                                class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition duration-200 text-sm">
                            ‡∏™‡∏≤‡∏¢
                        </button>
                        <button onclick="setAttendanceStatus('${student.code}', 'business')" 
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-200 text-sm">
                            ‡∏•‡∏≤‡∏Å‡∏¥‡∏à
                        </button>
                        <button onclick="setAttendanceStatus('${student.code}', 'sick')" 
                                class="px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 transition duration-200 text-sm">
                            ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢
                        </button>
                    </div>
                    <div id="status-${student.code}" class="ml-4 font-medium"></div>
                `;
                container.appendChild(div);
            });

            document.getElementById('attendanceList').classList.remove('hidden');
        }

        function setAttendanceStatus(studentCode, status) {
            const statusDiv = document.getElementById(`status-${studentCode}`);
            const statusText = {
                'present': '‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                'absent': '‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                'late': '‚è∞ ‡∏™‡∏≤‡∏¢',
                'business': 'üìã ‡∏•‡∏≤‡∏Å‡∏¥‡∏à',
                'sick': 'üè• ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢'
            };
            
            const statusColors = {
                'present': 'text-green-600',
                'absent': 'text-red-600',
                'late': 'text-yellow-600',
                'business': 'text-blue-600',
                'sick': 'text-purple-600'
            };

            statusDiv.textContent = statusText[status];
            statusDiv.className = `ml-4 font-medium ${statusColors[status]}`;
            statusDiv.setAttribute('data-status', status);
            
            // Check if all students have status
            checkAllStudentsStatus();
        }

        function checkAllStudentsStatus() {
            const statusDivs = document.querySelectorAll('[id^="status-"]');
            const saveBtn = document.getElementById('saveAttendanceBtn');
            
            let allHaveStatus = true;
            statusDivs.forEach(div => {
                if (!div.getAttribute('data-status')) {
                    allHaveStatus = false;
                }
            });

            if (allHaveStatus && statusDivs.length > 0) {
                saveBtn.disabled = false;
                saveBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200';
            } else {
                saveBtn.disabled = true;
                saveBtn.className = 'bg-gray-400 text-white px-4 py-2 rounded-lg transition duration-200 cursor-not-allowed';
            }
        }

        async function saveAttendance() {
            const grade = document.getElementById('gradeSelect').value;
            const subject = document.getElementById('subjectSelect').value;
            const date = document.getElementById('attendanceDate').value;

            if (!grade || !subject || !date) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
                return;
            }

            const statusDivs = document.querySelectorAll('[id^="status-"]');
            const attendanceData = [];
            let missingStatus = false;

            statusDivs.forEach(div => {
                const status = div.getAttribute('data-status');
                const studentCode = div.id.replace('status-', '');
                const student = students.find(s => s.code === studentCode);
                
                if (!status) {
                    missingStatus = true;
                } else {
                    attendanceData.push({
                        studentCode: studentCode,
                        studentName: student.name,
                        grade: grade,
                        subject: subject,
                        date: date,
                        status: status,
                        timestamp: new Date()
                    });
                }
            });

            if (missingStatus) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
                return;
            }

            try {
                const batch = db.batch();
                
                attendanceData.forEach(record => {
                    const docId = `${record.studentCode}_${record.subject}_${record.date}`;
                    const docRef = db.collection('attendance').doc(docId);
                    batch.set(docRef, record);
                });

                await batch.commit();

                // Calculate summary
                const summary = {
                    present: attendanceData.filter(r => r.status === 'present').length,
                    absent: attendanceData.filter(r => r.status === 'absent').length,
                    late: attendanceData.filter(r => r.status === 'late').length,
                    business: attendanceData.filter(r => r.status === 'business').length,
                    sick: attendanceData.filter(r => r.status === 'sick').length
                };

                // Show summary popup
                const subjectName = subjects.find(s => s.code === subject)?.name || subject;
                Swal.fire({
                    icon: 'success',
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    html: `
                        <div class="text-left">
                            <h4 class="font-semibold mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h4>
                            <p class="mb-2"><strong>‡∏ß‡∏¥‡∏ä‡∏≤:</strong> ${subjectName}</p>
                            <p class="mb-2"><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${date}</p>
                            <div class="mt-4 space-y-2">
                                <div class="flex justify-between">
                                    <span>‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                                    <span class="font-semibold text-green-600">${summary.present} ‡∏Ñ‡∏ô</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                                    <span class="font-semibold text-red-600">${summary.absent} ‡∏Ñ‡∏ô</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>‚è∞ ‡∏™‡∏≤‡∏¢:</span>
                                    <span class="font-semibold text-yellow-600">${summary.late} ‡∏Ñ‡∏ô</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>üìã ‡∏•‡∏≤‡∏Å‡∏¥‡∏à:</span>
                                    <span class="font-semibold text-blue-600">${summary.business} ‡∏Ñ‡∏ô</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>üè• ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢:</span>
                                    <span class="font-semibold text-purple-600">${summary.sick} ‡∏Ñ‡∏ô</span>
                                </div>
                                <div class="border-t pt-2 mt-2">
                                    <div class="flex justify-between">
                                        <span><strong>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong></span>
                                        <span class="font-bold">${attendanceData.length} ‡∏Ñ‡∏ô</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });

                // Clear status and reset button
                statusDivs.forEach(div => {
                    div.textContent = '';
                    div.removeAttribute('data-status');
                });
                
                const saveBtn = document.getElementById('saveAttendanceBtn');
                saveBtn.disabled = true;
                saveBtn.className = 'bg-gray-400 text-white px-4 py-2 rounded-lg transition duration-200 cursor-not-allowed';

            } catch (error) {
                console.error('Error saving attendance:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
            }
        }

        // Report Functions
        async function loadGradesForReport() {
            await loadStudents();
        }

        async function loadSubjectsForReport() {
            await loadSubjects();
            const select = document.getElementById('reportSubjectSelect');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.code;
                option.textContent = `${subject.code} - ${subject.name}`;
                select.appendChild(option);
            });
        }

        // Global variable to store current report data
        let currentReportData = [];

        async function loadReportData() {
            const grade = document.getElementById('reportGradeSelect').value;
            const subject = document.getElementById('reportSubjectSelect').value;
            const date = document.getElementById('reportDate').value;

            if (!grade && !subject && !date) {
                document.getElementById('reportTableBody').innerHTML = '';
                currentReportData = [];
                updateExportButton();
                return;
            }

            try {
                let query = db.collection('attendance');
                
                if (grade) {
                    query = query.where('grade', '==', grade);
                }
                if (subject) {
                    query = query.where('subject', '==', subject);
                }
                if (date) {
                    query = query.where('date', '==', date);
                }

                const snapshot = await query.get();
                const tbody = document.getElementById('reportTableBody');
                tbody.innerHTML = '';
                currentReportData = [];

                snapshot.forEach(doc => {
                    const record = doc.data();
                    currentReportData.push(record);
                    
                    const row = document.createElement('tr');
                    
                    const statusText = {
                        'present': '‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                        'absent': '‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                        'late': '‚è∞ ‡∏™‡∏≤‡∏¢',
                        'business': 'üìã ‡∏•‡∏≤‡∏Å‡∏¥‡∏à',
                        'sick': 'üè• ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢'
                    };

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.studentCode}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.studentName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${statusText[record.status]}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(record.timestamp.toDate()).toLocaleString('th-TH')}</td>
                    `;
                    tbody.appendChild(row);
                });

                updateExportButton();

            } catch (error) {
                console.error('Error loading report data:', error);
                currentReportData = [];
                updateExportButton();
            }
        }

        function updateExportButton() {
            const exportBtn = document.getElementById('exportExcelBtn');
            
            if (currentReportData.length > 0) {
                exportBtn.disabled = false;
                exportBtn.className = 'bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition duration-200 flex items-center space-x-2';
            } else {
                exportBtn.disabled = true;
                exportBtn.className = 'bg-gray-400 text-white px-6 py-3 rounded-lg transition duration-200 cursor-not-allowed flex items-center space-x-2';
            }
        }

        async function viewStudentReport(studentCode) {
            try {
                const studentDoc = await db.collection('students').doc(studentCode).get();
                if (studentDoc.exists) {
                    const student = studentDoc.data();
                    hideAllSections();
                    document.getElementById('individualStudentReport').classList.remove('hidden');
                    await loadIndividualStudentReport(student);
                }
            } catch (error) {
                console.error('Error loading student report:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
            }
        }

        function backToStudentManagement() {
            hideAllSections();
            document.getElementById('studentManagement').classList.remove('hidden');
        }

        async function loadIndividualStudentReport(student) {
            // Display student info
            document.getElementById('individualStudentInfo').innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="text-4xl">üë§</div>
                    <div>
                        <h3 class="text-xl font-bold text-blue-800">${student.name}</h3>
                        <p class="text-blue-600">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${student.code}</p>
                        <p class="text-blue-600">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô: ${student.grade}</p>
                    </div>
                </div>
            `;

            try {
                // Load attendance records
                const snapshot = await db.collection('attendance')
                    .where('studentCode', '==', student.code)
                    .get();

                if (snapshot.empty) {
                    document.getElementById('overallSummary').innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>';
                    document.getElementById('subjectSummary').innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>';
                    document.getElementById('individualRecordsTable').innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>';
                    return;
                }

                const records = [];
                snapshot.forEach(doc => {
                    records.push(doc.data());
                });

                // Sort records by date descending
                records.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Calculate overall summary
                const totalRecords = records.length;
                const presentCount = records.filter(r => r.status === 'present').length;
                const absentCount = records.filter(r => r.status === 'absent').length;
                const lateCount = records.filter(r => r.status === 'late').length;
                const businessCount = records.filter(r => r.status === 'business').length;
                const sickCount = records.filter(r => r.status === 'sick').length;
                
                // Calculate absence according to rules
                const otherAbsences = lateCount + businessCount + sickCount;
                const calculatedAbsences = Math.floor(otherAbsences / 2); // 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á = ‡∏Ç‡∏≤‡∏î 1
                const totalAbsences = absentCount + calculatedAbsences;
                const examStatus = totalAbsences >= 4 ? "‡∏Ç‡∏£ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏™‡∏≠‡∏ö)" : "‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏™‡∏≠‡∏ö";
                const examStatusColor = totalAbsences >= 4 ? "text-red-600" : "text-green-600";
                
                const attendanceRate = ((presentCount / totalRecords) * 100).toFixed(1);

                document.getElementById('overallSummary').innerHTML = `
                    <div class="flex justify-between"><span>üìä ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span><span class="font-semibold">${totalRecords} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                    <div class="flex justify-between"><span>‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span><span class="font-semibold text-green-600">${presentCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                    <div class="flex justify-between"><span>‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span><span class="font-semibold text-red-600">${absentCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                    <div class="flex justify-between"><span>‚è∞ ‡∏™‡∏≤‡∏¢:</span><span class="font-semibold text-yellow-600">${lateCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                    <div class="flex justify-between"><span>üìã ‡∏•‡∏≤‡∏Å‡∏¥‡∏à:</span><span class="font-semibold text-blue-600">${businessCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                    <div class="flex justify-between"><span>üè• ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢:</span><span class="font-semibold text-purple-600">${sickCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                    <div class="border-t pt-2 mt-2 space-y-1">
                        <div class="flex justify-between"><span>üßÆ ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î‡∏£‡∏ß‡∏° (‡∏ï‡∏≤‡∏°‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤):</span><span class="font-bold text-red-600">${totalAbsences} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                        <div class="text-xs text-gray-600 ml-4">‚Ä¢ ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${absentCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                        <div class="text-xs text-gray-600 ml-4">‚Ä¢ ‡∏™‡∏≤‡∏¢/‡∏•‡∏≤: ${otherAbsences} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á = ${calculatedAbsences} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ç‡∏≤‡∏î</div>
                        <div class="flex justify-between"><span>üéØ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≠‡∏ö:</span><span class="font-bold ${examStatusColor}">${examStatus}</span></div>
                        <div class="flex justify-between"><span>üìà ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span><span class="font-bold text-lg ${attendanceRate >= 80 ? 'text-green-600' : attendanceRate >= 60 ? 'text-yellow-600' : 'text-red-600'}">${attendanceRate}%</span></div>
                    </div>
                `;

                // Calculate subject summary
                const subjectSummary = {};
                records.forEach(record => {
                    if (!subjectSummary[record.subject]) {
                        subjectSummary[record.subject] = {
                            present: 0,
                            absent: 0,
                            late: 0,
                            business: 0,
                            sick: 0,
                            total: 0
                        };
                    }
                    subjectSummary[record.subject][record.status]++;
                    subjectSummary[record.subject].total++;
                });

                let subjectHTML = '';
                Object.keys(subjectSummary).forEach(subject => {
                    const data = subjectSummary[subject];
                    const percentage = ((data.present / data.total) * 100).toFixed(1);
                    
                    // Calculate absence for this subject
                    const subjectOtherAbsences = data.late + data.business + data.sick;
                    const subjectCalculatedAbsences = Math.floor(subjectOtherAbsences / 2);
                    const subjectTotalAbsences = data.absent + subjectCalculatedAbsences;
                    const subjectExamStatus = subjectTotalAbsences >= 4 ? "‡∏Ç‡∏£" : "‡∏ú‡πà‡∏≤‡∏ô";
                    const subjectExamStatusColor = subjectTotalAbsences >= 4 ? "text-red-600" : "text-green-600";
                    
                    // Find subject name
                    const subjectInfo = subjects.find(s => s.code === subject);
                    const subjectName = subjectInfo ? subjectInfo.name : subject;
                    
                    subjectHTML += `
                        <div class="bg-white p-3 rounded border">
                            <div class="font-medium text-purple-800 mb-1">${subject} - ${subjectName}</div>
                            <div class="text-sm space-y-1">
                                <div class="flex justify-between">
                                    <span>‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                                    <span class="text-green-600">${data.present}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                                    <span class="text-red-600">${data.absent}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>‚è∞ ‡∏™‡∏≤‡∏¢:</span>
                                    <span class="text-yellow-600">${data.late}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>üìã ‡∏•‡∏≤‡∏Å‡∏¥‡∏à:</span>
                                    <span class="text-blue-600">${data.business}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>üè• ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢:</span>
                                    <span class="text-purple-600">${data.sick}</span>
                                </div>
                                <div class="border-t pt-1 mt-1 space-y-1">
                                    <div class="flex justify-between">
                                        <span class="font-medium">üßÆ ‡∏Ç‡∏≤‡∏î‡∏£‡∏ß‡∏°:</span>
                                        <span class="font-bold text-red-600">${subjectTotalAbsences} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium">üéØ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                                        <span class="font-bold ${subjectExamStatusColor}">${subjectExamStatus}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå:</span>
                                        <span class="font-semibold ${percentage >= 80 ? 'text-green-600' : percentage >= 60 ? 'text-yellow-600' : 'text-red-600'}">${percentage}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('subjectSummary').innerHTML = subjectHTML;

                // Display detailed records
                let recordsHTML = '';
                records.forEach(record => {
                    const statusText = {
                        'present': '‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                        'absent': '‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                        'late': '‚è∞ ‡∏™‡∏≤‡∏¢',
                        'business': 'üìã ‡∏•‡∏≤‡∏Å‡∏¥‡∏à',
                        'sick': 'üè• ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢'
                    };

                    const statusColor = {
                        'present': 'text-green-600',
                        'absent': 'text-red-600',
                        'late': 'text-yellow-600'
                    };

                    recordsHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm">${record.date}</td>
                            <td class="px-4 py-3 text-sm">${record.subject}</td>
                            <td class="px-4 py-3 text-sm ${statusColor[record.status]} font-medium">${statusText[record.status]}</td>
                            <td class="px-4 py-3 text-sm">${new Date(record.timestamp.toDate()).toLocaleString('th-TH')}</td>
                        </tr>
                    `;
                });

                document.getElementById('individualRecordsTable').innerHTML = recordsHTML;

            } catch (error) {
                console.error('Error loading individual student report:', error);
                
                // Show user-friendly error message
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
                
                document.getElementById('overallSummary').innerHTML = '<p class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>';
                document.getElementById('subjectSummary').innerHTML = '<p class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>';
                document.getElementById('individualRecordsTable').innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</td></tr>';
            }
        }

        // Attendance History Functions
        let currentEditRecord = null;

        async function loadAttendanceHistory() {
            await loadStudents();
            await loadSubjects();
            
            // Populate filter options
            const historySubjectFilter = document.getElementById('historySubjectFilter');
            historySubjectFilter.innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.code;
                option.textContent = `${subject.code} - ${subject.name}`;
                historySubjectFilter.appendChild(option);
            });

            const historyGradeFilter = document.getElementById('historyGradeFilter');
            const grades = [...new Set(students.map(s => s.grade))].sort();
            historyGradeFilter.innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>';
            grades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                historyGradeFilter.appendChild(option);
            });

            // Load all attendance records
            await filterAttendanceHistory();
        }

        async function filterAttendanceHistory() {
            const dateFilter = document.getElementById('historyDateFilter').value;
            const subjectFilter = document.getElementById('historySubjectFilter').value;
            const gradeFilter = document.getElementById('historyGradeFilter').value;
            const studentFilter = document.getElementById('historyStudentFilter').value;

            try {
                // Load all records first, then filter client-side to avoid Firestore query limitations
                const snapshot = await db.collection('attendance').get();
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = '';

                let filteredRecords = [];
                snapshot.forEach(doc => {
                    const record = doc.data();
                    record.docId = doc.id; // Add document ID for reference
                    
                    // Apply filters
                    let matchesFilter = true;
                    
                    if (dateFilter && record.date !== dateFilter) {
                        matchesFilter = false;
                    }
                    if (subjectFilter && record.subject !== subjectFilter) {
                        matchesFilter = false;
                    }
                    if (gradeFilter && record.grade !== gradeFilter) {
                        matchesFilter = false;
                    }
                    if (studentFilter && !record.studentCode.includes(studentFilter)) {
                        matchesFilter = false;
                    }
                    
                    if (matchesFilter) {
                        filteredRecords.push(record);
                    }
                });

                // Sort by date descending
                filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (filteredRecords.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</td></tr>';
                    updateBulkDeleteButton();
                    return;
                }

                const statusText = {
                    'present': '‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                    'absent': '‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                    'late': '‚è∞ ‡∏™‡∏≤‡∏¢',
                    'business': 'üìã ‡∏•‡∏≤‡∏Å‡∏¥‡∏à',
                    'sick': 'üè• ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢'
                };

                filteredRecords.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="record-checkbox" value="${record.docId}" onchange="updateBulkDeleteButton()">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.subject}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.studentCode}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.studentName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${statusText[record.status]}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editAttendanceRecord('${record.docId}', '${record.studentCode}', '${record.studentName}', '${record.subject}', '${record.date}', '${record.status}')" 
                                    class="text-blue-600 hover:text-blue-900 mr-3">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button onclick="deleteAttendanceRecord('${record.docId}', '${record.studentName}', '${record.subject}', '${record.date}')" 
                                    class="text-red-600 hover:text-red-900">‡∏•‡∏ö</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                updateBulkDeleteButton();

            } catch (error) {
                console.error('Error loading attendance history:', error);
                document.getElementById('historyTableBody').innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
            }
        }

        function editAttendanceRecord(docId, studentCode, studentName, subject, date, currentStatus) {
            currentEditRecord = { docId, studentCode, studentName, subject, date, currentStatus };
            
            document.getElementById('editAttendanceInfo').innerHTML = `
                <div class="space-y-2">
                    <div><strong>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${studentName} (${studentCode})</div>
                    <div><strong>‡∏ß‡∏¥‡∏ä‡∏≤:</strong> ${subject}</div>
                    <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${date}</div>
                    <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> ${getStatusText(currentStatus)}</div>
                </div>
            `;
            
            document.getElementById('newAttendanceStatus').value = currentStatus;
            document.getElementById('editAttendanceModal').classList.remove('hidden');
        }

        function closeEditAttendanceModal() {
            document.getElementById('editAttendanceModal').classList.add('hidden');
            currentEditRecord = null;
        }

        async function updateAttendanceStatus() {
            if (!currentEditRecord) return;

            const newStatus = document.getElementById('newAttendanceStatus').value;
            
            if (newStatus === currentEditRecord.currentStatus) {
                closeEditAttendanceModal();
                return;
            }

            try {
                await db.collection('attendance').doc(currentEditRecord.docId).update({
                    status: newStatus,
                    updatedAt: new Date()
                });

                Swal.fire({
                    icon: 'success',
                    title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á ${currentEditRecord.studentName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                    timer: 1500,
                    showConfirmButton: false
                });

                closeEditAttendanceModal();
                await filterAttendanceHistory();

            } catch (error) {
                console.error('Error updating attendance:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
            }
        }

        function getStatusText(status) {
            const statusText = {
                'present': '‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                'absent': '‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                'late': '‚è∞ ‡∏™‡∏≤‡∏¢',
                'business': 'üìã ‡∏•‡∏≤‡∏Å‡∏¥‡∏à',
                'sick': 'üè• ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢'
            };
            return statusText[status] || status;
        }

        async function deleteAttendanceRecord(docId, studentName, subject, date) {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                html: `
                    <div class="text-left">
                        <p class="mb-2">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                        <div class="bg-gray-50 p-3 rounded mt-3">
                            <div><strong>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${studentName}</div>
                            <div><strong>‡∏ß‡∏¥‡∏ä‡∏≤:</strong> ${subject}</div>
                            <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${date}</div>
                        </div>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#ef4444'
            });

            if (result.isConfirmed) {
                try {
                    await db.collection('attendance').doc(docId).delete();
                    
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: '‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        timer: 1500,
                        showConfirmButton: false
                    });

                    await filterAttendanceHistory();

                } catch (error) {
                    console.error('Error deleting attendance record:', error);
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                    });
                }
            }
        }

        function clearAllFilters() {
            document.getElementById('historyDateFilter').value = '';
            document.getElementById('historySubjectFilter').value = '';
            document.getElementById('historyGradeFilter').value = '';
            document.getElementById('historyStudentFilter').value = '';
            
            Swal.fire({
                icon: 'info',
                title: '‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß',
                text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...',
                timer: 1000,
                showConfirmButton: false
            });
            
            filterAttendanceHistory();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const recordCheckboxes = document.querySelectorAll('.record-checkbox');
            
            recordCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateBulkDeleteButton();
        }

        function updateBulkDeleteButton() {
            const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const allCheckboxes = document.querySelectorAll('.record-checkbox');
            
            if (checkedBoxes.length > 0) {
                bulkDeleteBtn.disabled = false;
                bulkDeleteBtn.className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition duration-200 text-sm';
                bulkDeleteBtn.textContent = `üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (${checkedBoxes.length})`;
            } else {
                bulkDeleteBtn.disabled = true;
                bulkDeleteBtn.className = 'bg-red-400 text-white px-4 py-2 rounded-lg transition duration-200 text-sm cursor-not-allowed';
                bulkDeleteBtn.textContent = 'üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (0)';
            }
            
            // Update select all checkbox state
            if (allCheckboxes.length > 0) {
                if (checkedBoxes.length === allCheckboxes.length) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else if (checkedBoxes.length > 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                }
            }
        }

        async function bulkDeleteRecords() {
            const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
            
            if (checkedBoxes.length === 0) {
                return;
            }

            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                html: `
                    <div class="text-left">
                        <p class="mb-3">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ <strong>${checkedBoxes.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                        <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                            <p class="text-yellow-800 text-sm">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
                        </div>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: `‡∏•‡∏ö ${checkedBoxes.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#ef4444'
            });

            if (result.isConfirmed) {
                try {
                    // Show loading
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                        text: `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö ${checkedBoxes.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Delete records in batches
                    const batch = db.batch();
                    checkedBoxes.forEach(checkbox => {
                        const docRef = db.collection('attendance').doc(checkbox.value);
                        batch.delete(docRef);
                    });

                    await batch.commit();

                    Swal.fire({
                        icon: 'success',
                        title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: `‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ${checkedBoxes.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                        timer: 2000,
                        showConfirmButton: false
                    });

                    // Reset checkboxes and reload data
                    document.getElementById('selectAllCheckbox').checked = false;
                    await filterAttendanceHistory();

                } catch (error) {
                    console.error('Error bulk deleting records:', error);
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                    });
                }
            }
        }

        async function exportToExcel() {
            if (currentReportData.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    text: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡πà‡∏≠‡∏ô',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
                return;
            }

            try {
                // Show loading
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel...',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Get filter values for filename
                const grade = document.getElementById('reportGradeSelect').value;
                const subject = document.getElementById('reportSubjectSelect').value;
                const date = document.getElementById('reportDate').value;

                // Prepare data for Excel
                const excelData = [];
                
                // Add header row
                excelData.push([
                    '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                    '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•',
                    '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô',
                    '‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤',
                    '‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤',
                    '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà',
                    '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                    '‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'
                ]);

                // Sort data by student code
                const sortedData = [...currentReportData].sort((a, b) => a.studentCode.localeCompare(b.studentCode));

                // Add data rows
                sortedData.forEach(record => {
                    const statusText = {
                        'present': '‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                        'absent': '‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                        'late': '‡∏™‡∏≤‡∏¢',
                        'business': '‡∏•‡∏≤‡∏Å‡∏¥‡∏à',
                        'sick': '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢'
                    };

                    // Find subject name
                    const subjectInfo = subjects.find(s => s.code === record.subject);
                    const subjectName = subjectInfo ? subjectInfo.name : '';

                    excelData.push([
                        record.studentCode,
                        record.studentName,
                        record.grade,
                        record.subject,
                        subjectName,
                        record.date,
                        statusText[record.status] || record.status,
                        new Date(record.timestamp.toDate()).toLocaleString('th-TH')
                    ]);
                });

                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);

                // Set column widths
                const colWidths = [
                    { wch: 15 }, // ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    { wch: 25 }, // ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
                    { wch: 12 }, // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô
                    { wch: 12 }, // ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤
                    { wch: 30 }, // ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤
                    { wch: 12 }, // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                    { wch: 18 }, // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    { wch: 20 }  // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                ];
                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');

                // Generate filename
                let filename = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
                if (grade) filename += `_${grade}`;
                if (subject) filename += `_${subject}`;
                if (date) filename += `_${date}`;
                filename += `_${new Date().toISOString().split('T')[0]}.xlsx`;

                // Save file
                XLSX.writeFile(wb, filename);

                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    html: `
                        <div class="text-left">
                            <p class="mb-3">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                            <div class="bg-green-50 p-3 rounded border border-green-200">
                                <div class="text-sm space-y-1">
                                    <div><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå:</strong> ${filename}</div>
                                    <div><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong> ${currentReportData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                                    ${grade ? `<div><strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</strong> ${grade}</div>` : ''}
                                    ${subject ? `<div><strong>‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤:</strong> ${subject}</div>` : ''}
                                    ${date ? `<div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${date}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });

            } catch (error) {
                console.error('Error exporting to Excel:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
            }
        }

        // Student Dashboard Functions
        async function loadStudentDetails(studentData) {
            const detailsDiv = document.getElementById('studentDetails');
            detailsDiv.innerHTML = `
                <div class="flex justify-between">
                    <span class="font-medium">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                    <span>${studentData.code}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span>
                    <span>${studentData.name}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</span>
                    <span>${studentData.grade}</span>
                </div>
            `;

            await loadStudentAttendanceData(studentData.code);
        }

        async function loadStudentAttendanceData(studentCode) {
            try {
                const snapshot = await db.collection('attendance')
                    .where('studentCode', '==', studentCode)
                    .get();

                const summaryDiv = document.getElementById('attendanceSummary');
                
                if (snapshot.empty) {
                    summaryDiv.innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>';
                    return;
                }

                const records = [];
                snapshot.forEach(doc => {
                    records.push(doc.data());
                });

                // Sort records by date descending
                records.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Load subjects for name lookup
                await loadSubjects();
                
                // Group by subject
                const subjectSummary = {};
                records.forEach(record => {
                    if (!subjectSummary[record.subject]) {
                        subjectSummary[record.subject] = {
                            present: 0,
                            absent: 0,
                            late: 0,
                            business: 0,
                            sick: 0,
                            total: 0
                        };
                    }
                    subjectSummary[record.subject][record.status]++;
                    subjectSummary[record.subject].total++;
                });

                let summaryHTML = '';
                Object.keys(subjectSummary).forEach(subject => {
                    const data = subjectSummary[subject];
                    const percentage = ((data.present / data.total) * 100).toFixed(1);
                    
                    // Calculate absence for this subject
                    const subjectOtherAbsences = data.late + data.business + data.sick;
                    const subjectCalculatedAbsences = Math.floor(subjectOtherAbsences / 2);
                    const subjectTotalAbsences = data.absent + subjectCalculatedAbsences;
                    const subjectExamStatus = subjectTotalAbsences >= 4 ? "‡∏Ç‡∏£ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏™‡∏≠‡∏ö)" : "‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏™‡∏≠‡∏ö";
                    const subjectExamStatusColor = subjectTotalAbsences >= 4 ? "text-red-600" : "text-green-600";
                    
                    // Find subject name
                    const subjectInfo = subjects.find(s => s.code === subject);
                    const subjectName = subjectInfo ? subjectInfo.name : subject;
                    
                    summaryHTML += `
                        <div class="bg-gray-50 p-4 rounded-lg border-l-4 ${subjectTotalAbsences >= 4 ? 'border-red-500' : 'border-green-500'}">
                            <h3 class="font-semibold mb-3 flex justify-between items-center">
                                <span>${subject} - ${subjectName}</span>
                                <span class="text-sm ${subjectExamStatusColor} font-bold">${subjectExamStatus}</span>
                            </h3>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-green-600">‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${data.present}</span><br>
                                    <span class="text-red-600">‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${data.absent}</span><br>
                                    <span class="text-yellow-600">‚è∞ ‡∏™‡∏≤‡∏¢: ${data.late}</span>
                                </div>
                                <div>
                                    <span class="text-blue-600">üìã ‡∏•‡∏≤‡∏Å‡∏¥‡∏à: ${data.business}</span><br>
                                    <span class="text-purple-600">üè• ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢: ${data.sick}</span><br>
                                    <span class="font-medium">üìä ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå: ${percentage}%</span>
                                </div>
                            </div>
                            <div class="mt-3 pt-2 border-t border-gray-300">
                                <div class="flex justify-between text-sm">
                                    <span class="font-medium">üßÆ ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î‡∏£‡∏ß‡∏° (‡∏ï‡∏≤‡∏°‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤):</span>
                                    <span class="font-bold text-red-600">${subjectTotalAbsences} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                                </div>
                                <div class="text-xs text-gray-600 mt-1">
                                    ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${data.absent} + ‡∏™‡∏≤‡∏¢/‡∏•‡∏≤ ${subjectOtherAbsences} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (=${subjectCalculatedAbsences} ‡∏Ç‡∏≤‡∏î)
                                </div>
                            </div>
                        </div>
                    `;
                });

                summaryDiv.innerHTML = summaryHTML;

            } catch (error) {
                console.error('Error loading student attendance:', error);
                
                // Show user-friendly error message
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
                
                document.getElementById('attendanceSummary').innerHTML = '<p class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>';
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9799d6dc2118a1b1',t:'MTc1Njk1MDY2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
